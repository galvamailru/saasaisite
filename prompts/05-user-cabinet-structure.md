# Структура кабинета пользователя (предложение для реализации)

Документ описывает предложенную структуру кабинета в рамках SaaS-платформы CIP (Conversational Interface Platform) с учётом мультитенантности (tenant_id, user_id) и концепции «сайт как диалог».

---

## 1. Роли и типы кабинетов

| Роль | Описание | Тип кабинета |
|------|----------|--------------|
| **Тенант (владелец инстанса)** | Клиент SaaS: компания/сайт, который арендует CIP. Владеет контентом агента, настройками, командой. | Кабинет тенанта (Tenant Cabinet / Dashboard) |
| **Администратор контента тенанта** | Пользователь тенанта с правами управления контентом и настройками агента. Может входить в кабинет тенанта и/или использовать админ-режим в чате (/admin). | Часть кабинета тенанта + диалог |
| **Конечный пользователь (посетитель)** | Гость сайта тенанта: общается с агентом, не имеет доступа к настройкам. Может иметь персональную историю в рамках тенанта (user_id). | Кабинет пользователя (User Cabinet) — опционально, минимальный |

Ниже — структура по каждому типу.

---

## 2. Кабинет тенанта (Tenant Cabinet)

**Назначение:** управление инстансом CIP: настройки агента и сайта, контент, команда, использование и биллинг.

**Доступ:** по аутентификации; привязка к tenant_id (текущий тенант из сессии/токена).

### 2.1 Предлагаемая структура разделов

```
/cabinet/                          → редирект на /cabinet/overview или /cabinet/chat
/cabinet/overview                  → сводка: последняя активность, лимиты, быстрые действия
/cabinet/chat                      → тот же чат-интерфейс, но в контексте кабинета (опционально вход в /admin через диалог)
/cabinet/settings                  → настройки инстанса
  /cabinet/settings/agent          → имя агента, приветствие, системный промпт (или путь к файлу промпта)
  /cabinet/settings/site           → домен/поддомен, логотип, favicon, мета-теги для iframe
  /cabinet/settings/integrations  → API-ключи, webhook (если в scope)
/cabinet/content                   → управление контентом (альтернатива/дополнение к админ-диалогу)
  /cabinet/content/portfolio       → разделы портфолио, медиа, триггеры
  /cabinet/content/services       → услуги/статьи, триггеры
  /cabinet/content/navigation      → quick-reply кнопки, структура навигации
/cabinet/team                      → участники тенанта, роли (owner, admin, viewer)
/cabinet/usage                     → использование: диалоги, сообщения, лимиты (если есть квоты)
/cabinet/billing                   → тариф, оплата, счета (если в scope продукта)
/cabinet/dialogs                   → список/поиск диалогов с посетителями (аналитика и поддержка)
```

### 2.2 Данные и API (идеи для бэкенда)

- Все маршруты кабинета тенанта требуют **tenant_id** (из сессии/JWT) и роль **tenant_admin** или **tenant_owner**.
- Сущности: `tenant`, `tenant_settings`, `tenant_member` (user_id + tenant_id + role), контент уже привязан к tenant_id.
- Настройки агента/сайта: отдельная таблица или JSON по tenant_id; промпт — файл или поле, ключ — tenant_id.

---

## 3. Кабинет конечного пользователя (User Cabinet)

**Назначение:** персональная зона посетителя сайта тенанта: история диалогов, сохранённое, при необходимости — профиль. В концепции CIP основной интерфейс — чат, поэтому кабинет пользователя может быть минимальным и частично реализован **через диалог с агентом** (например, «Покажи мои прошлые диалоги», «Сохрани это»).

### 3.1 Вариант A: только через чат (без отдельного UI)

- Нет отдельного URL кабинета; всё через сценарии в чате.
- Агент по запросу показывает список последних диалогов, повторно открывает диалог по id.
- «Сохранённое» — сущность в БД (user_id + tenant_id), агент отдаёт список и детали по запросу.

### 3.2 Вариант B: минимальный отдельный кабинет

- URL в контексте тенанта, например: `/{tenant_slug}/my` или через поддомен.
- Разделы:
  - **Мои диалоги** — список диалогов (session_id/dialog_id), переход к просмотру/продолжению в чате.
  - **Сохранённое** — элементы, сохранённые из чата (если продукт это предусматривает).
  - **Профиль** — минимально: имя, контакт (опционально), настройки уведомлений (если есть).

Структура:

```
/{tenant}/           → чат (текущее поведение)
/{tenant}/my          → кабинет пользователя (если включён тенантом)
/{tenant}/my/dialogs  → список диалогов
/{tenant}/my/saved    → сохранённое
/{tenant}/my/profile  → профиль (минимальный)
```

- Идентификация: user_id в рамках tenant_id (анонимный id из cookie/сессии или после лёгкой регистрации).

---

## 4. Общая схема маршрутизации (предложение)

| Путь | Кто | Описание |
|------|-----|----------|
| `/` или `/{tenant_slug}/` | Все | Чат агента (iframe или основная страница) |
| `/{tenant_slug}/my/*` | Конечный пользователь | Кабинет пользователя (если включён) |
| `/cabinet/*` | Тенант (admin/owner) | Кабинет тенанта; tenant_id из сессии |

Вариант с поддоменом: `cabinet.{platform_domain}` для кабинета тенанта, `{tenant}.{platform_domain}` для чата и кабинета пользователя — на усмотрение реализации.

---

## 5. Рекомендации для реализации

1. **Фаза 1 (MVP):** Реализовать кабинет тенанта в минимальном виде: `overview`, `settings/agent` (и при необходимости `settings/site`), `content` (портфолио + навигация) и доступ к списку диалогов. Админ-режим в чате (/admin) оставить основным способом управления контентом по ТЗ.
2. **Кабинет пользователя:** Начать с Варианта A (всё через чат); при необходимости добавить Вариант B (отдельные страницы «Мои диалоги» / «Сохранённое»).
3. **Идентификация:** Для тенанта — отдельная сущность пользователя платформы (platform user_id) и привязка к tenant через `tenant_member`. Для посетителя — user_id в рамках tenant_id (анонимный или после регистрации).
4. **Согласование с Execution-Spec:** Текущий 04-execution-spec и 03-solution-hld не описывают кабинет; добавление кабинета — расширение scope. Имеет смысл зафиксировать в ТЗ или в отдельном spec-документе: границы (что входит в первый релиз), роли, маршруты и требования к API/БД.

---

## 6. Краткая структура данных (для справки)

- **tenant** — id, slug, name, created_at, settings (JSON или отдельные поля).
- **tenant_member** — tenant_id, user_id (platform), role (owner | admin | viewer).
- **dialog / session** — tenant_id, user_id (посетитель), id, created_at, updated_at.
- **message** — уже в scope: tenant_id, user_id, dialog_id, role, content, created_at.
- **user (посетитель)** — id (в рамках тенанта или глобальный), tenant_id, anonymous_id или email/phone — на усмотрение продукта.

Этот документ можно использовать как основу для обновления Execution-Spec или для отдельной спецификации модуля «Кабинет пользователя и тенанта».
