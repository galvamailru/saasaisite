# Пользовательские пути и User Stories: владелец кабинета (администратор) и клиент

Во всех путях `{slug}` — идентификатор тенанта (например `mycompany`). Базовый URL приложения: например `https://app.example.com` или `http://localhost:8000`.

---

## User Stories

### Владелец кабинета (администратор)

**Регистрация и вход**

- Как владелец кабинета, я хочу **зарегистрироваться по email и паролю**, чтобы получить доступ к своему личному кабинету.
- Как владелец кабинета, я хочу **получить письмо со ссылкой подтверждения**, чтобы система убедилась, что email мой.
- Как владелец кабинета, я хочу **перейти по ссылке из письма и подтвердить email**, чтобы разблокировать вход в кабинет.
- Как владелец кабинета, я хочу **войти по email и паролю**, чтобы попасть в личный кабинет и управлять ботом.

**Промпт и контент**

- Как владелец кабинета, я хочу **просматривать системный промпт агента**, чтобы понимать, как бот отвечает клиентам.
- Как владелец кабинета, я хочу **загружать файлы (фото, документы)** в кабинет, чтобы потом привязывать их к триггерам или галереям.
- Как владелец кабинета, я хочу **привязать к файлу триггер (фразу)**, чтобы при упоминании этой фразы клиентом в чате бот выдавал ссылку на файл.
- Как владелец кабинета, я хочу **объединять изображения в галереи**, чтобы показывать клиентам наборы фото (каталоги, портфолио и т.п.).
- Как владелец кабинета, я хочу **редактировать список файлов и триггеры через чат с ботом** (slash-команды), чтобы управлять контентом, не выходя из привычного интерфейса чата.

**Профиль и история**

- Как владелец кабинета, я хочу **видеть свои диалоги с системой** (если они ведутся в кабинете), чтобы иметь историю.
- Как владелец кабинета, я хочу **редактировать профиль** (имя, контакт), чтобы указать свои данные в кабинете.
- Как владелец кабинета, я хочу **выйти из кабинета**, чтобы закрыть сессию на общем устройстве.

### Клиент (посетитель чата)

**Общение с ботом**

- Как клиент, я хочу **открыть страницу чата** по ссылке сайта/тенанта, чтобы написать боту без регистрации.
- Как клиент, я хочу **отправить сообщение и получить ответ бота потоком** (по мере генерации), чтобы не ждать полный ответ целиком.
- Как клиент, я хочу **видеть историю диалога в рамках сессии/устройства**, чтобы продолжать разговор (при сохранении `user_id` в localStorage).
- Как клиент, я хочу **получать в ответе ссылки на файлы**, когда я упоминаю нужную фразу (триггер), чтобы быстро получить нужный документ или изображение.

**Без регистрации**

- Как клиент, я хочу **не регистрироваться и не входить**, чтобы сразу начать общение с ботом; меня идентифицируют анонимно по устройству/сессии.

---

## 1. Пути владельца кабинета (администратора)

Доступ к кабинету только после входа (JWT). Один зарегистрированный пользователь на один тенант, роль по умолчанию — admin.

### 1.1. Публичные страницы (без авторизации)

| Путь | Назначение |
|------|------------|
| `/{slug}/register` | Страница регистрации (email, пароль). После отправки — письмо с ссылкой подтверждения. |
| `/{slug}/login` | Страница входа (email, пароль). После успешного входа выдаётся JWT, редирект в кабинет. |
| `/{slug}/confirm` | Подтверждение email по ссылке из письма (`?token=...`). После успеха — сообщение и переход на логин. |

### 1.2. Личный кабинет (требуется JWT)

Единая SPA-страница `cabinet.html`, маршруты обрабатываются на клиенте (hash/path). Все запросы к API — с заголовком `Authorization: Bearer <token>`.

| Путь | Раздел | Назначение |
|------|--------|------------|
| `/{slug}/my` | Главная | То же, что «Мои диалоги». |
| `/{slug}/my/dialogs` | Мои диалоги | Список диалогов пользователя кабинета (история переписок в роли админа не используется для клиентского чата; диалоги привязаны к user_id из JWT). |
| `/{slug}/my/prompt` | Промпт | Просмотр системного промпта агента (только чтение). |
| `/{slug}/my/files` | Файлы | Список файлов пользователя (MinIO), загрузка, установка/очистка триггера, удаление, ссылка на файл. |
| `/{slug}/my/galleries` | Галереи | Список галерей, создание, добавление/удаление файлов в галерею, удаление галереи. |
| `/{slug}/my/admin-chat` | Админ-чат | Чат с ботом: управление файлами и галереями slash-командами (`/files`, `/trigger`, `/gallery` и т.д.). |
| `/{slug}/my/saved` | Сохранённое | Список сохранённых элементов (тип, reference_id). |
| `/{slug}/my/profile` | Профиль | Просмотр и редактирование профиля (display_name, contact). |

### 1.3. API кабинета (для владельца)

Базовый префикс: `GET/POST /api/v1/tenants/by-slug/{slug}` — получение `tenant_id` по slug.

Далее все запросы к кабинету: `/api/v1/tenants/{tenant_id}/me/...` и `/api/v1/tenants/{tenant_id}/admin/...` с заголовком `Authorization: Bearer <token>`.

| Метод | Путь | Назначение |
|-------|------|------------|
| GET | `/api/v1/tenants/{tenant_id}/me/dialogs` | Список диалогов |
| GET | `/api/v1/tenants/{tenant_id}/me/dialogs/{dialog_id}` | Сообщения диалога |
| GET | `/api/v1/tenants/{tenant_id}/me/prompt` | Текст промпта агента |
| GET | `/api/v1/tenants/{tenant_id}/me/files` | Список файлов |
| POST | `/api/v1/tenants/{tenant_id}/me/files` | Загрузка файла (multipart) |
| PATCH | `/api/v1/tenants/{tenant_id}/me/files/{file_id}` | Установка/очистка триггера |
| GET | `/api/v1/tenants/{tenant_id}/me/files/{file_id}/url` | Presigned URL файла |
| DELETE | `/api/v1/tenants/{tenant_id}/me/files/{file_id}` | Удаление файла |
| GET | `/api/v1/tenants/{tenant_id}/me/galleries` | Список галерей |
| POST | `/api/v1/tenants/{tenant_id}/me/galleries` | Создание галереи |
| DELETE | `/api/v1/tenants/{tenant_id}/me/galleries/{gallery_id}` | Удаление галереи |
| POST | `/api/v1/tenants/{tenant_id}/me/galleries/{gallery_id}/items` | Добавить файл в галерею |
| DELETE | `/api/v1/tenants/{tenant_id}/me/galleries/{gallery_id}/items/{item_id}` | Удалить из галереи |
| POST | `/api/v1/tenants/{tenant_id}/admin/chat` | Админ-чат (тело: `{ "message": "..." }`, ответ: `{ "reply": "..." }`) |
| GET | `/api/v1/tenants/{tenant_id}/me/saved` | Список сохранённого |
| POST | `/api/v1/tenants/{tenant_id}/me/saved` | Добавить в сохранённое |
| DELETE | `/api/v1/tenants/{tenant_id}/me/saved/{saved_id}` | Удалить из сохранённого |
| GET | `/api/v1/tenants/{tenant_id}/me/profile` | Профиль |
| PATCH | `/api/v1/tenants/{tenant_id}/me/profile` | Обновить профиль |

### 1.4. API авторизации (для владельца)

| Метод | Путь | Назначение |
|-------|------|------------|
| POST | `/api/v1/tenants/{tenant_id}/register` | Регистрация (email, password) |
| GET | `/api/v1/tenants/{tenant_id}/confirm?token=...` | Подтверждение email по токену |
| GET | `/api/v1/tenants/by-slug/{slug}/confirm?token=...` | То же по slug тенанта |
| POST | `/api/v1/tenants/{tenant_id}/login` | Вход (email, password) → JWT |

---

## 2. Пути клиента (посетителя чата)

Клиент — пользователь, который общается с чат-ботом на сайте тенанта. Идентификация анонимная: `user_id` в заголовке `X-User-Id` или из localStorage (генерируется на клиенте).

### 2.1. Страницы

| Путь | Назначение |
|------|------------|
| `/{slug}/chat` | Страница чата с ботом. Один интерфейс: ввод сообщения, поток ответа (SSE). История диалогов привязана к `user_id` клиента. |

Клиент не заходит в `/{slug}/my`, `/{slug}/login`, `/{slug}/register` — это пути владельца кабинета.

### 2.2. API чата (для клиента)

| Метод | Путь | Назначение |
|-------|------|------------|
| POST | `/api/v1/tenants/{tenant_id}/chat` | Отправить сообщение, получить поток ответа (SSE). Тело: `{ "user_id": "...", "message": "...", "dialog_id": null \| uuid }`. В заголовках клиент передаёт `X-User-Id` (или бэкенд берёт `user_id` из тела). |

При срабатывании триггера (фраза в сообщении клиента совпадает с триггером файла) в поток ответа добавляется ссылка на файл; она же сохраняется в сообщении ассистента.

---

## 3. Сводка по ролям

| Роль | Вход | Основные пути | Идентификация |
|------|------|----------------|---------------|
| **Владелец кабинета (админ)** | Регистрация → подтверждение email → логин | `/{slug}/register`, `/{slug}/login`, `/{slug}/confirm`, `/{slug}/my`, `/{slug}/my/files`, `/{slug}/my/galleries`, `/{slug}/my/admin-chat`, … | JWT (Bearer), `user_id` и `tenant_id` из токена |
| **Клиент** | Не требуется | `/{slug}/chat` | `X-User-Id` или анонимный id в теле/локальном хранилище |
