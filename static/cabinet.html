<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Кабинет</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    nav { margin-bottom: 1rem; }
    nav a { margin-right: 1rem; }
    .list { list-style: none; padding: 0; }
    .list li { padding: 0.5rem; border-bottom: 1px solid #eee; }
    .list li a { text-decoration: none; color: inherit; }
    .error { color: #c00; }
    .hint { font-size: 0.9rem; color: #555; margin-bottom: 0.75rem; }
    .hint a { color: #00acc1; }
    .chunk-card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; background: #fafafa; }
    .chunk-card textarea { width: 100%; min-height: 80px; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
    .chunk-meta { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; }
    .chunk-actions { margin-top: 0.5rem; }
    .chunk-actions button { margin-right: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 6px; border: none; background: #00acc1; color: #fff; cursor: pointer; font-size: 0.9rem; }
    .chunk-actions button:hover { background: #0097a7; }
    .chunk-actions button.delete { background: #c62828; }
    .chunk-actions button.delete:hover { background: #b71c1c; }
    .add-chunk-box { margin-top: 1rem; padding: 1rem; border: 1px dashed #00acc1; border-radius: 8px; background: #f0f9fa; }
    .add-chunk-box textarea { width: 100%; min-height: 100px; max-height: 200px; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #00acc1; border-radius: 4px; resize: vertical; }
    .add-chunk-box .counter { font-size: 0.85rem; color: #666; }
    .embed-code { font-family: monospace; font-size: 0.85rem; background: #263238; color: #aed581; padding: 1rem; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
    .embed-actions { margin-top: 0.75rem; }
    .embed-actions button { padding: 0.5rem 1rem; border-radius: 6px; border: none; background: #2e7d32; color: #fff; cursor: pointer; }
    .embed-actions button:hover { background: #1b5e20; }
    .main-page-wrap { display: flex; gap: 1.5rem; align-items: stretch; margin-top: 0.75rem; flex-wrap: wrap; }
    .main-page-chat { flex: 1 1 360px; min-width: 280px; }
    .main-page-chat .chat-frame { width: 100%; height: 520px; min-height: 400px; border: 1px solid #ddd; border-radius: 12px; display: block; }
    .main-page-embed { flex: 1 1 360px; min-width: 280px; max-width: 520px; }
    .main-page-embed .embed-section { margin-top: 0; }
    .main-page-embed .embed-code { max-height: 280px; overflow-y: auto; }
    @media (max-width: 720px) { .main-page-wrap { flex-direction: column; } .main-page-embed { max-width: none; } }
    .admin-chat-toggler { position: fixed; bottom: 24px; right: 24px; z-index: 1000; padding: 12px 20px; border: none; border-radius: 24px; background: #00acc1; color: #fff; font-size: 0.95rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 16px rgba(0,172,193,0.4); }
    .admin-chat-toggler:hover { background: #0097a7; }
    .admin-chat-popup { position: fixed; right: 24px; bottom: 72px; width: 400px; max-width: calc(100vw - 48px); max-height: 70vh; z-index: 1001; background: #fff; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); display: none; flex-direction: column; overflow: hidden; }
    body.show-admin-chat .admin-chat-popup { display: flex; }
    .admin-chat-popup-header { padding: 12px 16px; background: #00acc1; color: #fff; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .admin-chat-popup-header .close-btn { background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; line-height: 1; padding: 0 4px; }
    .admin-chat-popup .chat-log { flex: 1; min-height: 200px; max-height: 360px; }
    .admin-chat-popup .chat-input { margin: 0; padding: 8px; border-top: 1px solid #eee; }
    .chat-log { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; background: #fafafa; }
    .chat-msg { margin: 0.5rem 0; }
    .chat-msg.user { color: #06c; }
    .chat-msg.assistant { color: #363; }
    .chat-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .chat-input textarea { flex: 1; min-height: 60px; resize: vertical; }
    .date-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1.25rem; padding: 1rem; background: #f5f5f5; border-radius: 10px; }
    .date-filter label { font-size: 0.9rem; color: #555; }
    .date-filter input[type="date"] { padding: 0.5rem 0.75rem; border: 1px solid #ccc; border-radius: 8px; font-size: 0.95rem; }
    .date-filter button { padding: 0.5rem 1.25rem; border: none; border-radius: 8px; background: #00acc1; color: #fff; cursor: pointer; font-size: 0.9rem; }
    .date-filter button:hover { background: #0097a7; }
    .date-filter .reset-btn { background: #888; }
    .date-filter .reset-btn:hover { background: #666; }
    .dialog-cards { display: grid; gap: 0.75rem; }
    .dialog-card { padding: 1rem 1.25rem; border-radius: 12px; border: 1px solid #e0e0e0; background: #fff; transition: box-shadow 0.2s; cursor: pointer; }
    .dialog-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .dialog-card.has-lead { border-left: 4px solid #2e7d32; background: #f1f8e9; }
    .dialog-card .dialog-meta { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; margin-bottom: 0.5rem; font-size: 0.85rem; color: #666; }
    .dialog-card .dialog-meta .date { font-weight: 600; color: #333; }
    .dialog-card .dialog-meta .msg-count { color: #00acc1; }
    .dialog-card .dialog-meta .lead-badge { color: #2e7d32; font-weight: 600; }
    .dialog-card .dialog-preview { font-size: 0.9rem; color: #555; line-height: 1.4; }
    .leads-list .lead-item { padding: 1rem 1.25rem; border-radius: 12px; border: 1px solid #e0e0e0; margin-bottom: 0.75rem; background: #fff; }
    .leads-list .lead-item .contact { font-weight: 600; font-size: 1rem; color: #333; }
    .leads-list .lead-item .meta { font-size: 0.85rem; color: #666; margin-top: 0.35rem; }
    .leads-list .lead-item .lead-date { font-weight: 500; color: #00acc1; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <nav>
    <a href="#" data-page="my">Главная</a>
    <a href="#" data-page="dialogs">Диалоги</a>
    <a href="#" data-page="prompt">Промпт</a>
    <a href="#" data-page="leads">Лиды</a>
    <a href="#" data-page="profile">Профиль</a>
    <span id="authLinks"></span>
  </nav>
  <div id="content"></div>
  <button type="button" id="adminChatToggler" class="admin-chat-toggler" aria-label="Админ-чат">Админ-чат</button>
  <div id="adminChatPopup" class="admin-chat-popup">
    <div class="admin-chat-popup-header">Помощник по промпту <button type="button" class="close-btn" id="adminChatClose" aria-label="Закрыть">×</button></div>
    <div class="chat-log" id="adminChatLog"></div>
    <div class="chat-input"><textarea id="adminChatInput" placeholder="Напишите, чем помочь..."></textarea><button type="button" id="adminChatSend">Отправить</button></div>
  </div>
  <script>
    (function () {
      const path = window.location.pathname;
      const slugMatch = path.match(/^\/([^/]+)\//);
      const tenantSlug = slugMatch ? slugMatch[1] : null;
      if (!tenantSlug) {
        document.getElementById('content').innerHTML = '<p class="error">Неверный URL. Ожидается /{tenant_slug}/my...</p>';
        return;
      }

      let tenantId = null;
      let userId = localStorage.getItem('cip_user_id') || 'anon-' + Math.random().toString(36).slice(2, 12);
      if (!localStorage.getItem('cip_user_id')) localStorage.setItem('cip_user_id', userId);

      const base = '/api/v1/tenants';
      const headers = (json) => {
        const h = { Accept: 'application/json' };
        const token = localStorage.getItem('cip_access_token');
        if (token) h['Authorization'] = 'Bearer ' + token;
        else h['X-User-Id'] = userId;
        if (json) h['Content-Type'] = 'application/json';
        return h;
      };

      function requireAuth() {
        if (!localStorage.getItem('cip_access_token')) {
          window.location.href = '/' + tenantSlug + '/login?next=/' + tenantSlug + '/my';
          return false;
        }
        return true;
      }

      function renderAuthLinks() {
        const token = localStorage.getItem('cip_access_token');
        const el = document.getElementById('authLinks');
        const toggler = document.getElementById('adminChatToggler');
        if (toggler) toggler.style.display = token ? '' : 'none';
        if (token) {
          el.innerHTML = '<a href="#" id="logoutBtn">Выйти</a>';
          const btn = document.getElementById('logoutBtn');
          if (btn) btn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('cip_access_token');
            localStorage.removeItem('cip_user_id');
            localStorage.removeItem('cip_tenant_id');
            window.location.href = '/' + tenantSlug + '/login';
          });
        } else {
          el.innerHTML = '<a href="/' + tenantSlug + '/login">Войти</a> <a href="/' + tenantSlug + '/register">Регистрация</a>';
        }
      }

      async function ensureTenant() {
        if (tenantId) return;
        const r = await fetch(base + '/by-slug/' + encodeURIComponent(tenantSlug));
        if (!r.ok) throw new Error('Тенант не найден');
        const t = await r.json();
        tenantId = t.id;
      }

      function setLinks() {
        document.querySelectorAll('nav a[data-page]').forEach(a => {
          const page = a.getAttribute('data-page');
          a.href = '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page);
        });
      }

      function formatDate(isoStr) {
        if (!isoStr) return '—';
        try {
          const d = new Date(isoStr);
          return isNaN(d.getTime()) ? isoStr : d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (_) { return isoStr; }
      }

      async function loadDialogs(dateFromVal, dateToVal) {
        if (!requireAuth()) return;
        await ensureTenant();
        let url = base + '/' + tenantId + '/me/tenant/dialogs?limit=50&offset=0';
        if (dateFromVal) url += '&date_from=' + encodeURIComponent(dateFromVal);
        if (dateToVal) url += '&date_to=' + encodeURIComponent(dateToVal);
        const r = await fetch(url, { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки диалогов. Войдите в кабинет.</p>';
          return;
        }
        const data = await r.json();
        const items = data.items || [];
        let html = '<h2>Диалоги</h2>';
        html += '<div class="date-filter">';
        html += '<label>С: <input type="date" id="dialogsDateFrom" value="' + escapeHtml(dateFromVal || '') + '"></label>';
        html += '<label>По: <input type="date" id="dialogsDateTo" value="' + escapeHtml(dateToVal || '') + '"></label>';
        html += '<button type="button" id="dialogsFilterBtn">Применить</button>';
        html += '<button type="button" class="reset-btn" id="dialogsFilterReset">Сбросить</button>';
        html += '<span class="hint" style="margin-left:0.5rem;">Всего: ' + (data.total || 0) + '</span>';
        html += '</div>';
        if (items.length === 0) {
          html += '<p class="hint">Нет диалогов за выбранный период. Диалоги посетителей с ботом через iframe появятся здесь.</p>';
        } else {
          html += '<div class="dialog-cards">';
          for (const d of items) {
            const preview = (d.preview || '').slice(0, 80) + (d.preview && d.preview.length > 80 ? '…' : '');
            const leadClass = d.has_lead ? ' has-lead' : '';
            html += '<div class="dialog-card' + leadClass + '" data-dialog-id="' + escapeHtml(d.id) + '">';
            html += '<div class="dialog-meta">';
            html += '<span class="date">' + formatDate(d.updated_at) + '</span>';
            html += '<span class="msg-count">' + (d.message_count || 0) + ' сообщ.</span>';
            if (d.has_lead) html += '<span class="lead-badge">✓ Лид</span>';
            html += '<span>' + escapeHtml(d.user_id || '') + '</span>';
            html += '</div>';
            html += '<div class="dialog-preview">' + escapeHtml(preview) + '</div>';
            html += '</div>';
          }
          html += '</div>';
        }
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('.dialog-card').forEach(function(el) {
          el.addEventListener('click', function() {
            const id = el.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + id);
            route();
          });
        });
        var filterBtn = document.getElementById('dialogsFilterBtn');
        if (filterBtn) filterBtn.addEventListener('click', function() {
          var from = document.getElementById('dialogsDateFrom').value;
          var to = document.getElementById('dialogsDateTo').value;
          loadDialogs(from || undefined, to || undefined);
        });
        var resetBtn = document.getElementById('dialogsFilterReset');
        if (resetBtn) resetBtn.addEventListener('click', function() {
          document.getElementById('dialogsDateFrom').value = '';
          document.getElementById('dialogsDateTo').value = '';
          loadDialogs();
        });
      }

      async function loadDialogDetail(dialogId) {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/tenant/dialogs/' + dialogId, { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Диалог не найден.</p><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p>';
          return;
        }
        const d = await r.json();
        let html = '<h2>Диалог</h2><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p><ul class="list">';
        for (const m of (d.messages || [])) {
          html += '<li><strong>' + escapeHtml(m.role || '') + ':</strong> ' + escapeHtml((m.content || '').slice(0, 500)) + (m.content && m.content.length > 500 ? '…' : '') + '</li>';
        }
        html += '</ul>';
        document.getElementById('content').innerHTML = html;
      }

      const CHUNK_MAX = 500;

      async function loadChunks() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/prompt/chunks', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки чанков.</p>';
          return;
        }
        const chunks = await r.json();
        let html = '<h2>Промпт чат-бота (чанки)</h2>';
        html += '<p class="hint">Промпт собирается из чанков (каждый до 500 символов). Порядок по position. Можно добавлять, редактировать и удалять чанки здесь или через <a href="#" data-goto="admin-chat">Админ-чат</a>.</p>';
        for (const c of chunks) {
          const contentEsc = (c.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          html += '<div class="chunk-card" data-chunk-id="' + c.id + '">';
          html += '<div class="chunk-meta">№' + c.position + ' · id: ' + c.id + ' · ' + (c.content || '').length + ' / ' + CHUNK_MAX + ' симв.</div>';
          html += '<textarea class="chunk-content" maxlength="' + CHUNK_MAX + '" data-chunk-id="' + c.id + '">' + contentEsc + '</textarea>';
          html += '<div class="chunk-actions"><button type="button" class="saveChunk" data-chunk-id="' + c.id + '">Сохранить</button><button type="button" class="delete deleteChunk" data-chunk-id="' + c.id + '">Удалить</button></div>';
          html += '</div>';
        }
        html += '<div class="add-chunk-box"><p>Добавить чанк (до ' + CHUNK_MAX + ' символов):</p><textarea id="newChunkContent" placeholder="Текст чанка..." maxlength="' + CHUNK_MAX + '"></textarea><div class="counter"><span id="newChunkCounter">0</span> / ' + CHUNK_MAX + '</div><button type="button" id="addChunkBtn">Добавить чанк</button></div>';
        document.getElementById('content').innerHTML = html;

        document.getElementById('newChunkContent').addEventListener('input', function () {
          document.getElementById('newChunkCounter').textContent = this.value.length;
        });

        document.getElementById('addChunkBtn').addEventListener('click', async () => {
          const text = document.getElementById('newChunkContent').value.trim();
          if (!text) { alert('Введите текст чанка'); return; }
          const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ content: text })
          });
          if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
          document.getElementById('newChunkContent').value = '';
          document.getElementById('newChunkCounter').textContent = '0';
          loadChunks();
        });

        document.getElementById('content').querySelectorAll('.saveChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cid = btn.getAttribute('data-chunk-id');
            const ta = document.querySelector('.chunk-content[data-chunk-id="' + cid + '"]');
            const content = ta ? ta.value.trim() : '';
            if (!content) { alert('Текст не может быть пустым'); return; }
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'PATCH',
              headers: headers(true),
              body: JSON.stringify({ content: content })
            });
            if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
            loadChunks();
          });
        });

        document.getElementById('content').querySelectorAll('.deleteChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Удалить этот чанк?')) return;
            const cid = btn.getAttribute('data-chunk-id');
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'DELETE',
              headers: headers()
            });
            if (!res.ok) { alert('Ошибка'); return; }
            loadChunks();
          });
        });
      }

      let adminChatInited = false;
      const adminChatHistory = [];

      function initAdminChatOnce() {
        if (adminChatInited) return;
        const log = document.getElementById('adminChatLog');
        const input = document.getElementById('adminChatInput');
        const send = document.getElementById('adminChatSend');
        if (!log || !send) return;
        function appendAdminMsg(role, text) {
          const div = document.createElement('div');
          div.className = 'chat-msg ' + role;
          div.textContent = (role === 'user' ? 'Вы: ' : 'Бот: ') + text;
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        }
        appendAdminMsg('assistant', 'Здравствуйте! Чем могу помочь? Хотите добавить или изменить чанки промпта бота для клиентов?');
        send.addEventListener('click', async () => {
          const msg = (input.value || '').trim();
          if (!msg) return;
          if (!tenantId) await ensureTenant();
          input.value = '';
          appendAdminMsg('user', msg);
          adminChatHistory.push({ role: 'user', content: msg });
          const res = await fetch(base + '/' + tenantId + '/admin/chat', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ message: msg, history: adminChatHistory.slice(0, -1) })
          });
          if (!res.ok) {
            const errText = await res.text();
            appendAdminMsg('assistant', 'Ошибка: ' + errText);
            adminChatHistory.push({ role: 'assistant', content: 'Ошибка: ' + errText });
            return;
          }
          const data = await res.json();
          const reply = data.reply || '';
          appendAdminMsg('assistant', reply);
          adminChatHistory.push({ role: 'assistant', content: reply });
        });
        adminChatInited = true;
      }

      document.getElementById('adminChatToggler').addEventListener('click', function() {
        document.body.classList.toggle('show-admin-chat');
        if (document.body.classList.contains('show-admin-chat')) {
          if (requireAuth()) {
            ensureTenant().then(function() { initAdminChatOnce(); });
          } else {
            initAdminChatOnce();
          }
        }
      });
      document.getElementById('adminChatClose').addEventListener('click', function() {
        document.body.classList.remove('show-admin-chat');
      });

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      async function loadLeads(dateFromVal, dateToVal) {
        if (!requireAuth()) return;
        await ensureTenant();
        let url = base + '/' + tenantId + '/me/leads?limit=50&offset=0';
        if (dateFromVal) url += '&date_from=' + encodeURIComponent(dateFromVal);
        if (dateToVal) url += '&date_to=' + encodeURIComponent(dateToVal);
        const r = await fetch(url, { headers: headers() });
        if (!r.ok) {
          const errBody = await r.text();
          let errMsg = 'Ошибка загрузки лидов.';
          try { const j = JSON.parse(errBody); errMsg = j.detail || errMsg; } catch (_) {}
          if (r.status === 401) errMsg = 'Войдите в кабинет.';
          document.getElementById('content').innerHTML = '<p class="error">' + escapeHtml(errMsg) + '</p>';
          return;
        }
        let data;
        try { data = await r.json(); } catch (_) {
          document.getElementById('content').innerHTML = '<p class="error">Неверный ответ сервера.</p>';
          return;
        }
        const leads = Array.isArray(data) ? data : (data.items || []);
        let html = '<h2>Лиды</h2>';
        html += '<p class="hint">Контакты (email, телефон), оставленные посетителями в чате. Один лид на диалог.</p>';
        html += '<div class="date-filter">';
        html += '<label>С: <input type="date" id="leadsDateFrom" value="' + escapeHtml(dateFromVal || '') + '"></label>';
        html += '<label>По: <input type="date" id="leadsDateTo" value="' + escapeHtml(dateToVal || '') + '"></label>';
        html += '<button type="button" id="leadsFilterBtn">Применить</button>';
        html += '<button type="button" class="reset-btn" id="leadsFilterReset">Сбросить</button>';
        html += '</div>';
        if (leads.length === 0) {
          html += '<p>Нет лидов за выбранный период.</p>';
        } else {
          html += '<ul class="list leads-list">';
          for (const l of leads) {
            html += '<li class="lead-item">';
            html += '<span class="contact">' + escapeHtml(l.contact_text) + '</span>';
            html += '<div class="meta">user: ' + escapeHtml(l.user_id) + ' · диалог: <a href="#" class="lead-dialog-link" data-dialog-id="' + escapeHtml(l.dialog_id) + '">открыть</a></div>';
            html += '<div class="lead-date">' + formatDate(l.updated_at || l.created_at) + '</div>';
            html += '</li>';
          }
          html += '</ul>';
        }
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('a.lead-dialog-link').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const dialogId = a.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + dialogId);
            route();
          });
        });
        var filterBtn = document.getElementById('leadsFilterBtn');
        if (filterBtn) filterBtn.addEventListener('click', function() {
          loadLeads(document.getElementById('leadsDateFrom').value || undefined, document.getElementById('leadsDateTo').value || undefined);
        });
        var resetBtn = document.getElementById('leadsFilterReset');
        if (resetBtn) resetBtn.addEventListener('click', function() {
          document.getElementById('leadsDateFrom').value = '';
          document.getElementById('leadsDateTo').value = '';
          loadLeads();
        });
      }

      async function loadProfile() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/profile', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки профиля</p>';
          return;
        }
        const p = await r.json();
        document.getElementById('content').innerHTML =
          '<h2>Профиль</h2><p>user_id: ' + (p.user_id || '') + '</p><p>Имя: ' + (p.display_name || '—') + '</p><p>Контакт: ' + (p.contact || '—') + '</p>';
      }

      async function loadMy() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/embed', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки.</p>';
          return;
        }
        const data = await r.json();
        const code = (data.iframe_code || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        document.getElementById('content').innerHTML =
          '<h2>Главная</h2>' +
          '<p class="hint">Тестируйте бота в чате и скопируйте код для вставки на сайт. Диалоги пользователей — в <a href="#" data-goto="dialogs">Мои диалоги</a>.</p>' +
          '<div class="main-page-wrap">' +
          '<div class="main-page-chat">' +
          '<p class="hint" style="margin-bottom:0.5rem;">Чат для теста (режим теста — в БД не сохраняется)</p>' +
          '<iframe id="chatEmbedFrame" class="chat-frame" src="/' + tenantSlug + '/chat/embed" title="Чат для теста"></iframe>' +
          '</div>' +
          '<div class="main-page-embed">' +
          '<p class="hint" style="margin-bottom:0.5rem;">Вставка на ваш сайт</p>' +
          '<p class="hint">Тенант: <strong>' + escapeHtml(tenantSlug) + '</strong>. Задайте в .env <code>FRONTEND_BASE_URL</code>.</p>' +
          '<pre class="embed-code" id="embedCodePre">' + code + '</pre>' +
          '<div class="embed-actions"><button type="button" id="copyEmbedBtn">Копировать код</button></div>' +
          '</div>' +
          '</div>';
        var frame = document.getElementById('chatEmbedFrame');
        if (frame) {
          frame.addEventListener('load', function() {
            try {
              var uid = localStorage.getItem('cip_user_id');
              var token = localStorage.getItem('cip_access_token');
              if (uid && token) {
                frame.contentWindow.postMessage({ type: 'cip_auth', user_id: uid, token: token, is_test: true }, window.location.origin);
              }
            } catch (_) {}
          });
        }
        var copyBtn = document.getElementById('copyEmbedBtn');
        if (copyBtn) {
          copyBtn.addEventListener('click', function() {
            var pre = document.getElementById('embedCodePre');
            var text = pre ? pre.textContent : '';
            navigator.clipboard.writeText(text).then(function() { alert('Код скопирован в буфер обмена.'); }).catch(function() { alert('Не удалось скопировать.'); });
          });
        }
      }

      function route() {
        const segs = window.location.pathname.split('/').filter(Boolean);
        const page = segs[2] || 'my';
        setLinks();
        renderAuthLinks();
        if (page === 'my' || page === 'embed') loadMy();
        else if (page === 'dialogs' && segs[3]) loadDialogDetail(segs[3]);
        else if (page === 'dialogs') loadDialogs();
        else if (page === 'prompt') loadChunks();
        else if (page === 'leads') loadLeads();
        else if (page === 'profile') loadProfile();
        else loadMy();
      }

      document.querySelectorAll('nav a[data-page]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const page = a.getAttribute('data-page');
          window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
          route();
        });
      });
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-goto]');
        if (!a) return;
        e.preventDefault();
        const page = a.getAttribute('data-goto');
        window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
        route();
      });
      window.onpopstate = route;
      route();
    })();
  </script>
</body>
</html>
