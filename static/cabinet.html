<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Кабинет</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    nav { margin-bottom: 1rem; }
    nav a { margin-right: 1rem; }
    .list { list-style: none; padding: 0; }
    .list li { padding: 0.5rem; border-bottom: 1px solid #eee; }
    .list li a { text-decoration: none; color: inherit; }
    .error { color: #c00; }
    .hint { font-size: 0.9rem; color: #555; margin-bottom: 0.75rem; }
    .hint a { color: #00acc1; }
    .chunk-card { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; background: #fafafa; }
    .chunk-card textarea { width: 100%; min-height: 80px; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; resize: vertical; }
    .chunk-meta { font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; }
    .chunk-actions { margin-top: 0.5rem; }
    .chunk-actions button { margin-right: 0.5rem; padding: 0.4rem 0.8rem; border-radius: 6px; border: none; background: #00acc1; color: #fff; cursor: pointer; font-size: 0.9rem; }
    .chunk-actions button:hover { background: #0097a7; }
    .chunk-actions button.delete { background: #c62828; }
    .chunk-actions button.delete:hover { background: #b71c1c; }
    .add-chunk-box { margin-top: 1rem; padding: 1rem; border: 1px dashed #00acc1; border-radius: 8px; background: #f0f9fa; }
    .add-chunk-box textarea { width: 100%; min-height: 100px; max-height: 200px; font-size: 0.9rem; padding: 0.5rem; border: 1px solid #00acc1; border-radius: 4px; resize: vertical; }
    .add-chunk-box .counter { font-size: 0.85rem; color: #666; }
    .embed-code { font-family: monospace; font-size: 0.85rem; background: #263238; color: #aed581; padding: 1rem; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
    .embed-actions { margin-top: 0.75rem; }
    .embed-actions button { padding: 0.5rem 1rem; border-radius: 6px; border: none; background: #2e7d32; color: #fff; cursor: pointer; }
    .embed-actions button:hover { background: #1b5e20; }
    .chat-log { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 0.5rem; margin-bottom: 0.5rem; background: #fafafa; }
    .chat-msg { margin: 0.5rem 0; }
    .chat-msg.user { color: #06c; }
    .chat-msg.assistant { color: #363; }
    .chat-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .chat-input textarea { flex: 1; min-height: 60px; resize: vertical; }
  </style>
</head>
<body>
  <nav>
    <a href="#" data-page="my">Главная</a>
    <a href="#" data-page="dialogs">Мои диалоги</a>
    <a href="#" data-page="prompt">Промпт</a>
    <a href="#" data-page="embed">Вставка на сайт</a>
    <a href="#" data-page="admin-chat">Админ-чат</a>
    <a href="#" data-page="leads">Лиды</a>
    <a href="#" data-page="profile">Профиль</a>
    <span id="authLinks"></span>
  </nav>
  <div id="content"></div>
  <script>
    (function () {
      const path = window.location.pathname;
      const slugMatch = path.match(/^\/([^/]+)\//);
      const tenantSlug = slugMatch ? slugMatch[1] : null;
      if (!tenantSlug) {
        document.getElementById('content').innerHTML = '<p class="error">Неверный URL. Ожидается /{tenant_slug}/my...</p>';
        return;
      }

      let tenantId = null;
      let userId = localStorage.getItem('cip_user_id') || 'anon-' + Math.random().toString(36).slice(2, 12);
      if (!localStorage.getItem('cip_user_id')) localStorage.setItem('cip_user_id', userId);

      const base = '/api/v1/tenants';
      const headers = (json) => {
        const h = { Accept: 'application/json' };
        const token = localStorage.getItem('cip_access_token');
        if (token) h['Authorization'] = 'Bearer ' + token;
        else h['X-User-Id'] = userId;
        if (json) h['Content-Type'] = 'application/json';
        return h;
      };

      function requireAuth() {
        if (!localStorage.getItem('cip_access_token')) {
          window.location.href = '/' + tenantSlug + '/login?next=/' + tenantSlug + '/my';
          return false;
        }
        return true;
      }

      function renderAuthLinks() {
        const token = localStorage.getItem('cip_access_token');
        const el = document.getElementById('authLinks');
        if (token) {
          el.innerHTML = '<a href="#" id="logoutBtn">Выйти</a>';
          const btn = document.getElementById('logoutBtn');
          if (btn) btn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('cip_access_token');
            localStorage.removeItem('cip_user_id');
            localStorage.removeItem('cip_tenant_id');
            window.location.href = '/' + tenantSlug + '/login';
          });
        } else {
          el.innerHTML = '<a href="/' + tenantSlug + '/login">Войти</a> <a href="/' + tenantSlug + '/register">Регистрация</a>';
        }
      }

      async function ensureTenant() {
        if (tenantId) return;
        const r = await fetch(base + '/by-slug/' + encodeURIComponent(tenantSlug));
        if (!r.ok) throw new Error('Тенант не найден');
        const t = await r.json();
        tenantId = t.id;
      }

      function setLinks() {
        document.querySelectorAll('nav a[data-page]').forEach(a => {
          const page = a.getAttribute('data-page');
          a.href = '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page);
        });
      }

      async function loadDialogs() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/dialogs?limit=20&offset=0', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки диалогов. Войдите в кабинет.</p>';
          return;
        }
        const data = await r.json();
        let html = '<h2>Мои диалоги</h2><ul class="list">';
        for (const d of data.items || []) {
          const preview = (d.preview || '').slice(0, 60) + (d.preview && d.preview.length > 60 ? '…' : '');
          html += '<li><a href="#" class="dialog-link" data-dialog-id="' + (d.id || '') + '">' + (d.id || '') + '</a> ' + (d.updated_at || '') + ' — ' + escapeHtml(preview) + '</li>';
        }
        html += '</ul>';
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('a.dialog-link').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const id = a.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + id);
            route();
          });
        });
      }

      async function loadDialogDetail(dialogId) {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/dialogs/' + dialogId, { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Диалог не найден.</p><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p>';
          return;
        }
        const d = await r.json();
        let html = '<h2>Диалог</h2><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p><ul class="list">';
        for (const m of (d.messages || [])) {
          html += '<li><strong>' + escapeHtml(m.role || '') + ':</strong> ' + escapeHtml((m.content || '').slice(0, 500)) + (m.content && m.content.length > 500 ? '…' : '') + '</li>';
        }
        html += '</ul>';
        document.getElementById('content').innerHTML = html;
      }

      const CHUNK_MAX = 500;

      async function loadChunks() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/prompt/chunks', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки чанков.</p>';
          return;
        }
        const chunks = await r.json();
        let html = '<h2>Промпт чат-бота (чанки)</h2>';
        html += '<p class="hint">Промпт собирается из чанков (каждый до 500 символов). Порядок по position. Можно добавлять, редактировать и удалять чанки здесь или через <a href="#" data-goto="admin-chat">Админ-чат</a>.</p>';
        for (const c of chunks) {
          const contentEsc = (c.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          html += '<div class="chunk-card" data-chunk-id="' + c.id + '">';
          html += '<div class="chunk-meta">№' + c.position + ' · id: ' + c.id + ' · ' + (c.content || '').length + ' / ' + CHUNK_MAX + ' симв.</div>';
          html += '<textarea class="chunk-content" maxlength="' + CHUNK_MAX + '" data-chunk-id="' + c.id + '">' + contentEsc + '</textarea>';
          html += '<div class="chunk-actions"><button type="button" class="saveChunk" data-chunk-id="' + c.id + '">Сохранить</button><button type="button" class="delete deleteChunk" data-chunk-id="' + c.id + '">Удалить</button></div>';
          html += '</div>';
        }
        html += '<div class="add-chunk-box"><p>Добавить чанк (до ' + CHUNK_MAX + ' символов):</p><textarea id="newChunkContent" placeholder="Текст чанка..." maxlength="' + CHUNK_MAX + '"></textarea><div class="counter"><span id="newChunkCounter">0</span> / ' + CHUNK_MAX + '</div><button type="button" id="addChunkBtn">Добавить чанк</button></div>';
        document.getElementById('content').innerHTML = html;

        document.getElementById('newChunkContent').addEventListener('input', function () {
          document.getElementById('newChunkCounter').textContent = this.value.length;
        });

        document.getElementById('addChunkBtn').addEventListener('click', async () => {
          const text = document.getElementById('newChunkContent').value.trim();
          if (!text) { alert('Введите текст чанка'); return; }
          const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ content: text })
          });
          if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
          document.getElementById('newChunkContent').value = '';
          document.getElementById('newChunkCounter').textContent = '0';
          loadChunks();
        });

        document.getElementById('content').querySelectorAll('.saveChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cid = btn.getAttribute('data-chunk-id');
            const ta = document.querySelector('.chunk-content[data-chunk-id="' + cid + '"]');
            const content = ta ? ta.value.trim() : '';
            if (!content) { alert('Текст не может быть пустым'); return; }
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'PATCH',
              headers: headers(true),
              body: JSON.stringify({ content: content })
            });
            if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
            loadChunks();
          });
        });

        document.getElementById('content').querySelectorAll('.deleteChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Удалить этот чанк?')) return;
            const cid = btn.getAttribute('data-chunk-id');
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'DELETE',
              headers: headers()
            });
            if (!res.ok) { alert('Ошибка'); return; }
            loadChunks();
          });
        });
      }

      async function loadEmbed() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/embed', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки.</p>';
          return;
        }
        const data = await r.json();
        const code = (data.iframe_code || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        document.getElementById('content').innerHTML =
          '<h2>Вставка чата на сайт</h2>' +
          '<p class="hint">Скопируйте код ниже и вставьте в HTML-страницу вашего сайта. Чат откроется в iframe по ссылке: <strong>' + (data.chat_url || '') + '</strong></p>' +
          '<pre class="embed-code" id="embedCodePre">' + code + '</pre>' +
          '<div class="embed-actions"><button type="button" id="copyEmbedBtn">Копировать код</button></div>';
        document.getElementById('copyEmbedBtn').addEventListener('click', () => {
          const pre = document.getElementById('embedCodePre');
          const text = pre.textContent;
          navigator.clipboard.writeText(text).then(() => alert('Код скопирован в буфер обмена.')).catch(() => alert('Не удалось скопировать.'));
        });
      }

      async function loadAdminChat() {
        if (!requireAuth()) return;
        await ensureTenant();
        let html = '<h2>Админ-чат</h2>';
        html += '<p class="hint">Общайтесь с ботом: он предложит добавить или изменить чанки промпта. Прямое редактирование — в разделе <a href="#" data-goto="prompt">Промпт</a>.</p>';
        html += '<div class="chat-log" id="adminChatLog"></div>';
        html += '<div class="chat-input"><textarea id="adminChatInput" placeholder="Напишите, чем помочь..."></textarea><button id="adminChatSend">Отправить</button></div>';
        document.getElementById('content').innerHTML = html;

        const log = document.getElementById('adminChatLog');
        const input = document.getElementById('adminChatInput');
        const send = document.getElementById('adminChatSend');
        const adminChatHistory = [];
        appendMsg('assistant', 'Здравствуйте! Чем могу помочь? Хотите добавить или изменить чанки промпта бота для клиентов?');

        function appendMsg(role, text) {
          const div = document.createElement('div');
          div.className = 'chat-msg ' + role;
          div.textContent = (role === 'user' ? 'Вы: ' : 'Бот: ') + text;
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        }

        send.addEventListener('click', async () => {
          const msg = (input.value || '').trim();
          if (!msg) return;
          input.value = '';
          appendMsg('user', msg);
          adminChatHistory.push({ role: 'user', content: msg });
          const res = await fetch(base + '/' + tenantId + '/admin/chat', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({
              message: msg,
              history: adminChatHistory.slice(0, -1)
            })
          });
          if (!res.ok) {
            const errText = await res.text();
            appendMsg('assistant', 'Ошибка: ' + errText);
            adminChatHistory.push({ role: 'assistant', content: 'Ошибка: ' + errText });
            return;
          }
          const data = await res.json();
          const reply = data.reply || '';
          appendMsg('assistant', reply);
          adminChatHistory.push({ role: 'assistant', content: reply });
        });
      }

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      async function loadLeads() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/leads?limit=50&offset=0', { headers: headers() });
        if (!r.ok) {
          const errBody = await r.text();
          let errMsg = 'Ошибка загрузки лидов.';
          try { const j = JSON.parse(errBody); errMsg = j.detail || errMsg; } catch (_) {}
          if (r.status === 401) errMsg = 'Войдите в кабинет.';
          document.getElementById('content').innerHTML = '<p class="error">' + escapeHtml(errMsg) + '</p>';
          return;
        }
        let data;
        try { data = await r.json(); } catch (_) {
          document.getElementById('content').innerHTML = '<p class="error">Неверный ответ сервера.</p>';
          return;
        }
        const leads = Array.isArray(data) ? data : (data.items || []);
        let html = '<h2>Лиды</h2>';
        html += '<p class="hint">Контакты (email, телефон), оставленные посетителями в чате. Один лид на диалог.</p>';
        if (leads.length === 0) {
          html += '<p>Нет лидов</p>';
        } else {
          html += '<ul class="list leads-list">';
          for (const l of leads) {
            html += '<li class="lead-item">';
            html += '<span class="contact">' + escapeHtml(l.contact_text) + '</span>';
            html += '<div class="meta">user: ' + escapeHtml(l.user_id) + ' · диалог: <a href="#" class="lead-dialog-link" data-dialog-id="' + escapeHtml(l.dialog_id) + '">' + escapeHtml(l.dialog_id) + '</a></div>';
            html += '<div class="meta">' + (l.updated_at || l.created_at || '') + '</div>';
            html += '</li>';
          }
          html += '</ul>';
        }
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('a.lead-dialog-link').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const dialogId = a.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + dialogId);
            route();
          });
        });
      }

      async function loadProfile() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/profile', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки профиля</p>';
          return;
        }
        const p = await r.json();
        document.getElementById('content').innerHTML =
          '<h2>Профиль</h2><p>user_id: ' + (p.user_id || '') + '</p><p>Имя: ' + (p.display_name || '—') + '</p><p>Контакт: ' + (p.contact || '—') + '</p>';
      }

      async function loadMy() {
        if (!requireAuth()) return;
        await ensureTenant();
        document.getElementById('content').innerHTML =
          '<h2>Главная</h2>' +
          '<p class="hint">Тестируйте бота в чате ниже. Диалоги сохраняются и отображаются в <a href="#" data-goto="dialogs">Мои диалоги</a>.</p>' +
          '<iframe id="chatEmbedFrame" src="/' + tenantSlug + '/chat/embed" style="width:100%; height:75vh; border:1px solid #ddd; border-radius:12px;" title="Чат для теста"></iframe>';
        var frame = document.getElementById('chatEmbedFrame');
        if (frame) {
          frame.addEventListener('load', function() {
            try {
              var uid = localStorage.getItem('cip_user_id');
              var token = localStorage.getItem('cip_access_token');
              if (uid && token) {
                frame.contentWindow.postMessage({ type: 'cip_auth', user_id: uid, token: token }, window.location.origin);
              }
            } catch (_) {}
          });
        }
      }

      function route() {
        const segs = window.location.pathname.split('/').filter(Boolean);
        const page = segs[2] || 'my';
        setLinks();
        renderAuthLinks();
        if (page === 'my') loadMy();
        else if (page === 'dialogs' && segs[3]) loadDialogDetail(segs[3]);
        else if (page === 'dialogs') loadDialogs();
        else if (page === 'prompt') loadChunks();
        else if (page === 'embed') loadEmbed();
        else if (page === 'admin-chat') loadAdminChat();
        else if (page === 'leads') loadLeads();
        else if (page === 'profile') loadProfile();
        else loadMy();
      }

      document.querySelectorAll('nav a[data-page]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const page = a.getAttribute('data-page');
          window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
          route();
        });
      });
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-goto]');
        if (!a) return;
        e.preventDefault();
        const page = a.getAttribute('data-goto');
        window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
        route();
      });
      window.onpopstate = route;
      route();
    })();
  </script>
</body>
</html>
