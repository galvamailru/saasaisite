<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Кабинет</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    :root {
      --bg: #0f1419;
      --surface: #1a2332;
      --border: #2d3a4d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-dim: #388bfd;
      --success: #3fb950;
      --danger: #f85149;
      --font-mono: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding: 0; min-height: 100vh; }
    body::before { content: ''; position: fixed; inset: 0; background: linear-gradient(180deg, rgba(88,166,255,0.03) 0%, transparent 50%); pointer-events: none; z-index: 0; }
    #content { position: relative; z-index: 1; padding: 1.25rem 1.5rem; max-width: 960px; margin: 0 auto; }
    nav {
      background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.75rem 1.5rem; margin-bottom: 0;
      display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem;
    }
    nav a {
      color: var(--text-muted); text-decoration: none; font-size: 0.9rem; padding: 0.5rem 0.75rem; border-radius: 6px;
      transition: color 0.15s, background 0.15s;
    }
    nav a:hover { color: var(--accent); background: rgba(88,166,255,0.08); }
    #authLinks { margin-left: auto; }
    #authLinks a { color: var(--text-muted); }
    .list { list-style: none; padding: 0; }
    .list li { padding: 0.6rem 0; border-bottom: 1px solid var(--border); }
    .list li a { text-decoration: none; color: var(--accent); }
    .list li a:hover { text-decoration: underline; }
    .error { color: var(--danger); }
    .hint { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.75rem; }
    .hint a { color: var(--accent); }
    .hint code { font-family: var(--font-mono); font-size: 0.8em; background: var(--surface); padding: 0.15rem 0.4rem; border-radius: 4px; }
    h2 { font-size: 1.25rem; font-weight: 600; margin: 0 0 0.75rem; color: var(--text); }
    h3 { font-size: 1.05rem; color: var(--text-muted); margin: 1rem 0 0.5rem; }
    .panel { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; }
    .chunk-card, .dialog-card, .leads-list .lead-item { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; margin-bottom: 0.75rem; }
    .chunk-question-label { font-size: 0.75rem; color: var(--accent); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.35rem; font-family: var(--font-mono); }
    .chunk-card .chunk-question-input, .chunk-card textarea, .admin-prompt-system textarea {
      width: 100%; display: block; font-size: 0.9rem; padding: 0.5rem 0.65rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
      color: var(--text); resize: vertical; margin-bottom: 0.5rem;
    }
    .chunk-card textarea.chunk-content { min-height: 80px; }
    .chunk-card .chunk-question-input:focus, .chunk-card textarea:focus, .admin-prompt-system textarea:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(88,166,255,0.2);
    }
    .chunk-meta { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; font-family: var(--font-mono); }
    .chunk-actions { margin-top: 0.6rem; }
    .chunk-actions button, .embed-actions button, .date-filter button {
      margin-right: 0.5rem; padding: 0.45rem 0.9rem; border-radius: 6px; border: 1px solid var(--border); background: var(--surface);
      color: var(--text); cursor: pointer; font-size: 0.875rem; transition: background 0.15s, border-color 0.15s;
    }
    .chunk-actions button:hover, .embed-actions button:hover { background: var(--accent); border-color: var(--accent); color: #fff; }
    .add-chunk-box { margin-top: 1rem; padding: 1.25rem; border: 1px dashed var(--border); border-radius: 8px; background: rgba(88,166,255,0.04); }
    .add-chunk-box p { margin: 0 0 0.75rem 0; }
    .add-chunk-box input[type="text"], .add-chunk-box textarea { width: 100%; display: block; margin-bottom: 0.5rem; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 0.5rem 0.65rem; font-size: 0.9rem; box-sizing: border-box; }
    .add-chunk-box textarea { min-height: 100px; max-height: 200px; resize: vertical; }
    .add-chunk-box .counter { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); margin-bottom: 0.5rem; }
    .embed-code { font-family: var(--font-mono); font-size: 0.8rem; background: #0d1117; color: #7ee787; padding: 1rem; border-radius: 6px; border: 1px solid var(--border); overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
    .embed-actions { margin-top: 0.75rem; }
    .embed-actions button { background: var(--success); border-color: var(--success); color: #fff; }
    .embed-actions button:hover { filter: brightness(1.1); }
    .main-page-wrap { display: flex; gap: 1.5rem; align-items: stretch; margin-top: 0.75rem; flex-wrap: wrap; }
    .main-page-chat { flex: 1 1 360px; min-width: 280px; }
    .main-page-chat .chat-frame { width: 100%; height: 520px; min-height: 400px; border: 1px solid var(--border); border-radius: 8px; display: block; background: var(--surface); }
    .main-page-embed { flex: 1 1 360px; min-width: 280px; max-width: 520px; }
    .main-page-embed .embed-code { max-height: 280px; overflow-y: auto; }
    @media (max-width: 720px) { .main-page-wrap { flex-direction: column; } .main-page-embed { max-width: none; } }
    .admin-chat-toggler {
      position: fixed; bottom: 24px; right: 24px; z-index: 1000; padding: 10px 18px; border: 1px solid var(--accent); border-radius: 8px;
      background: rgba(88,166,255,0.12); color: var(--accent); font-size: 0.9rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3); transition: background 0.2s, box-shadow 0.2s;
    }
    .admin-chat-toggler:hover { background: var(--accent); color: #fff; box-shadow: 0 4px 20px rgba(88,166,255,0.35); }
    .admin-chat-popup {
      position: fixed; right: 24px; bottom: 72px; width: 400px; max-width: calc(100vw - 48px); max-height: 70vh; z-index: 1001;
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      display: none; flex-direction: column; overflow: hidden;
    }
    body.show-admin-chat .admin-chat-popup { display: flex; }
    .admin-chat-popup-header { padding: 10px 14px; background: var(--bg); border-bottom: 1px solid var(--border); color: var(--text); font-weight: 600; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
    .admin-chat-popup-header .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.3rem; cursor: pointer; line-height: 1; padding: 0 4px; }
    .admin-chat-popup-header .close-btn:hover { color: var(--text); }
    .admin-chat-popup .chat-log { flex: 1; min-height: 200px; max-height: 360px; background: var(--bg); padding: 0.75rem; overflow-y: auto; }
    .admin-chat-popup .chat-input { margin: 0; padding: 8px; border-top: 1px solid var(--border); background: var(--surface); }
    .admin-chat-popup .chat-input textarea { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
    .chat-log { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); padding: 0.75rem; margin-bottom: 0.5rem; background: var(--bg); border-radius: 6px; }
    .chat-msg { margin: 0.5rem 0; font-size: 0.9rem; }
    .chat-msg.user { color: var(--accent); }
    .chat-msg.assistant { color: var(--text-muted); }
    .chat-input { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .chat-input textarea { flex: 1; min-height: 60px; resize: vertical; }
    .date-filter { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; margin-bottom: 1.25rem; padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; }
    .date-filter label { font-size: 0.875rem; color: var(--text-muted); }
    .date-filter input[type="date"] { padding: 0.5rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; color: var(--text); }
    .date-filter button { background: var(--accent); border-color: var(--accent); color: #fff; }
    .date-filter button:hover { filter: brightness(1.1); }
    .dialog-cards { display: grid; gap: 0.75rem; }
    .dialog-card { cursor: pointer; transition: border-color 0.2s, background 0.2s; }
    .dialog-card:hover { border-color: var(--accent); background: rgba(88,166,255,0.06); }
    .dialog-card.has-lead { border-left: 3px solid var(--success); background: rgba(63,185,80,0.08); }
    .dialog-card .dialog-meta { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; margin-bottom: 0.35rem; font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }
    .dialog-card .dialog-meta .date { font-weight: 600; color: var(--text); }
    .dialog-card .dialog-meta .msg-count { color: var(--accent); }
    .dialog-card .dialog-meta .lead-badge { color: var(--success); font-weight: 600; }
    .dialog-card .dialog-meta .user-id { font-weight: normal; color: var(--text-muted); font-size: 0.8rem; }
    .leads-list .lead-item { border-radius: 6px; }
    .leads-list .lead-item .contact { font-weight: 600; font-size: 1rem; color: var(--text); }
    .leads-list .lead-item .meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.35rem; }
    .leads-list .lead-item .lead-date { font-weight: 500; color: var(--accent); margin-top: 0.25rem; font-family: var(--font-mono); }
    .admin-prompt-system { margin-bottom: 1.5rem; }
    .admin-prompt-system label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text); font-size: 0.9rem; }
    .admin-prompt-system textarea { min-height: 200px; }
    .admin-chunk-card { border: 1px solid var(--border); background: rgba(88,166,255,0.04); }
    .admin-chunk-card .chunk-question-input { margin-bottom: 0.5rem; }
    .admin-chunk-card textarea { min-height: 100px; }
    /* Глобальные формы */
    #content input:not([type="date"]):not([type="checkbox"]), #content textarea, #content select {
      background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 0.5rem 0.65rem;
    }
    #content button:not(.close-btn) { background: var(--surface); border: 1px solid var(--border); color: var(--text); border-radius: 6px; padding: 0.45rem 0.9rem; cursor: pointer; font-size: 0.875rem; }
    #content button:not(.close-btn):hover { background: var(--accent); border-color: var(--accent); color: #fff; }
    #content .date-filter button:not(.reset-btn), #content .chunk-actions button:not(.delete), #content .embed-actions button { background: var(--accent); border-color: var(--accent); color: #fff; }
    #content .chunk-actions button.delete { border-color: rgba(248,81,73,0.5); color: var(--danger); }
    #content .chunk-actions button.delete:hover { background: var(--danger); border-color: var(--danger); color: #fff; }
    #content .date-filter .reset-btn { background: var(--surface); color: var(--text-muted); }
    #content .date-filter .reset-btn:hover { background: var(--border); color: var(--text); }
    /* Галерея и RAG */
    .content-loading { color: var(--text-muted); padding: 2rem; text-align: center; }
    .page-gallery .gallery-create-panel, .page-rag .rag-upload-panel { margin-bottom: 1.5rem; }
    .page-gallery .gallery-create-panel h3, .page-rag .rag-upload-panel h3 { margin-top: 0; }
    .page-gallery .gallery-create-panel input, .page-gallery .gallery-create-panel textarea,
    .page-rag .rag-upload-panel input { display: block; width: 100%; margin-bottom: 0.5rem; }
    .page-rag .rag-upload-panel input[type="file"] { margin-bottom: 0.5rem; }
    .gallery-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .gallery-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem; }
    .gallery-card:hover { border-color: var(--accent); }
    .gallery-card-thumb { width: 100%; aspect-ratio: 16/10; background: var(--bg); border-radius: 6px; object-fit: cover; }
    .gallery-card-thumb.empty { display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.8rem; }
    .gallery-card-title { font-weight: 600; color: var(--text); }
    .gallery-card-meta { font-size: 0.8rem; color: var(--text-muted); font-family: var(--font-mono); }
    .gallery-card-desc { font-size: 0.875rem; color: var(--text-muted); line-height: 1.4; margin: 0; }
    .gallery-card-actions { display: flex; gap: 0.5rem; margin-top: auto; }
    .gallery-detail-back { margin-bottom: 1rem; }
    .gallery-detail-back a { color: var(--accent); text-decoration: none; }
    .gallery-detail-back a:hover { text-decoration: underline; }
    .gallery-images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
    .gallery-image-item { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative; }
    .gallery-image-item img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
    .gallery-image-item .img-url { font-size: 0.75rem; color: var(--text-muted); padding: 0.35rem 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .gallery-image-item .img-remove { position: absolute; top: 4px; right: 4px; padding: 0.25rem 0.5rem; font-size: 0.75rem; }
    .rag-doc-list { list-style: none; padding: 0; margin: 0; }
    .rag-doc-item { display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 0.5rem; }
    .rag-doc-item:hover { border-color: var(--border); }
    .rag-doc-info { flex: 1; min-width: 0; }
    .rag-doc-name { font-weight: 600; color: var(--text); }
    .rag-doc-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; font-family: var(--font-mono); }
    .rag-doc-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    #content input[type="file"] { font-size: 0.875rem; color: var(--text-muted); }
    /* Модальное окно предпросмотра Markdown (RAG) */
    .rag-preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 1rem; box-sizing: border-box; }
    .rag-preview-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; max-width: 720px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 12px 48px rgba(0,0,0,0.4); }
    .rag-preview-modal h3 { margin: 0; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); font-size: 1.1rem; color: var(--text); }
    .rag-preview-modal .rag-preview-body { padding: 1rem 1.25rem; overflow: auto; flex: 1; min-height: 0; }
    .rag-preview-modal .rag-preview-body label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.35rem; }
    .rag-preview-modal .rag-preview-body input[type="text"] { width: 100%; margin-bottom: 1rem; padding: 0.5rem 0.65rem; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; box-sizing: border-box; }
    .rag-preview-modal .rag-preview-body textarea { width: 100%; min-height: 280px; padding: 0.75rem; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-family: var(--font-mono); font-size: 0.85rem; resize: vertical; box-sizing: border-box; }
    .rag-preview-modal .rag-preview-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; }
    .rag-preview-modal .rag-preview-footer button { padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .rag-preview-modal .rag-preview-footer .btn-cancel { background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); }
    .rag-preview-modal .rag-preview-footer .btn-save { background: var(--success); border: 1px solid var(--success); color: #fff; }
    .rag-preview-modal .rag-preview-body textarea[readonly] { cursor: default; }
    /* Индикатор прогресса загрузки */
    .upload-progress-wrap { margin-top: 0.75rem; display: none; }
    .upload-progress-wrap.active { display: block; }
    .upload-progress-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-bottom: 0.35rem; }
    .upload-progress-bar .fill { height: 100%; background: var(--accent); border-radius: 3px; width: 0%; transition: width 0.2s ease; }
    .upload-progress-text { font-size: 0.8rem; color: var(--text-muted); }
    .upload-progress-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: upload-spin 0.7s linear infinite; vertical-align: middle; margin-right: 6px; }
    @keyframes upload-spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <nav>
    <a href="#" data-page="my">Главная</a>
    <a href="#" data-page="dialogs">Диалоги</a>
    <a href="#" data-page="prompt">Промпт</a>
    <a href="#" data-page="admin-prompt">Промпт админ-бота</a>
    <a href="#" data-page="gallery">Галерея</a>
    <a href="#" data-page="rag">Документы</a>
    <a href="#" data-page="leads">Лиды</a>
    <a href="#" data-page="profile">Профиль</a>
    <span id="authLinks"></span>
  </nav>
  <div id="content"></div>
  <button type="button" id="adminChatToggler" class="admin-chat-toggler" aria-label="Админ-чат">Админ-чат</button>
  <div id="adminChatPopup" class="admin-chat-popup">
    <div class="admin-chat-popup-header">Помощник по промпту <button type="button" class="close-btn" id="adminChatClose" aria-label="Закрыть">×</button></div>
    <div class="chat-log" id="adminChatLog"></div>
    <div class="chat-input"><textarea id="adminChatInput" placeholder="Напишите, чем помочь..."></textarea><button type="button" id="adminChatSend">Отправить</button></div>
  </div>
  <script>
    (function () {
      const path = window.location.pathname;
      const slugMatch = path.match(/^\/([^/]+)\//);
      const tenantSlug = slugMatch ? slugMatch[1] : null;
      if (!tenantSlug) {
        document.getElementById('content').innerHTML = '<p class="error">Неверный URL. Ожидается /{tenant_slug}/my...</p>';
        return;
      }

      let tenantId = null;
      let userId = localStorage.getItem('cip_user_id') || 'anon-' + Math.random().toString(36).slice(2, 12);
      if (!localStorage.getItem('cip_user_id')) localStorage.setItem('cip_user_id', userId);

      const base = '/api/v1/tenants';
      const headers = (json) => {
        const h = { Accept: 'application/json' };
        const token = localStorage.getItem('cip_access_token');
        if (token) h['Authorization'] = 'Bearer ' + token;
        else h['X-User-Id'] = userId;
        if (json) h['Content-Type'] = 'application/json';
        return h;
      };

      function requireAuth() {
        if (!localStorage.getItem('cip_access_token')) {
          window.location.href = '/' + tenantSlug + '/login?next=/' + tenantSlug + '/my';
          return false;
        }
        return true;
      }

      function renderAuthLinks() {
        const token = localStorage.getItem('cip_access_token');
        const el = document.getElementById('authLinks');
        const toggler = document.getElementById('adminChatToggler');
        if (toggler) toggler.style.display = token ? '' : 'none';
        if (token) {
          el.innerHTML = '<a href="#" id="logoutBtn">Выйти</a>';
          const btn = document.getElementById('logoutBtn');
          if (btn) btn.addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('cip_access_token');
            localStorage.removeItem('cip_user_id');
            localStorage.removeItem('cip_tenant_id');
            window.location.href = '/' + tenantSlug + '/login';
          });
        } else {
          el.innerHTML = '<a href="/' + tenantSlug + '/login">Войти</a> <a href="/' + tenantSlug + '/register">Регистрация</a>';
        }
      }

      async function ensureTenant() {
        if (tenantId) return;
        const r = await fetch(base + '/by-slug/' + encodeURIComponent(tenantSlug));
        if (!r.ok) throw new Error('Тенант не найден');
        const t = await r.json();
        tenantId = t.id;
      }

      function setLinks() {
        document.querySelectorAll('nav a[data-page]').forEach(a => {
          const page = a.getAttribute('data-page');
          a.href = '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page);
        });
      }

      function formatDate(isoStr) {
        if (!isoStr) return '—';
        try {
          const d = new Date(isoStr);
          return isNaN(d.getTime()) ? isoStr : d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (_) { return isoStr; }
      }

      async function loadDialogs(dateFromVal, dateToVal) {
        if (!requireAuth()) return;
        await ensureTenant();
        let url = base + '/' + tenantId + '/me/tenant/dialogs?limit=50&offset=0';
        if (dateFromVal) url += '&date_from=' + encodeURIComponent(dateFromVal);
        if (dateToVal) url += '&date_to=' + encodeURIComponent(dateToVal);
        const r = await fetch(url, { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки диалогов. Войдите в кабинет.</p>';
          return;
        }
        const data = await r.json();
        const items = data.items || [];
        let html = '<h2>Диалоги</h2>';
        html += '<div class="date-filter">';
        html += '<label>С: <input type="date" id="dialogsDateFrom" value="' + escapeHtml(dateFromVal || '') + '"></label>';
        html += '<label>По: <input type="date" id="dialogsDateTo" value="' + escapeHtml(dateToVal || '') + '"></label>';
        html += '<button type="button" id="dialogsFilterBtn">Применить</button>';
        html += '<button type="button" class="reset-btn" id="dialogsFilterReset">Сбросить</button>';
        html += '<span class="hint" style="margin-left:0.5rem;">Всего: ' + (data.total || 0) + '</span>';
        html += '</div>';
        if (items.length === 0) {
          html += '<p class="hint">Нет диалогов за выбранный период. Диалоги посетителей с ботом через iframe появятся здесь.</p>';
        } else {
          html += '<div class="dialog-cards">';
          for (const d of items) {
            const preview = (d.preview || '').slice(0, 80) + (d.preview && d.preview.length > 80 ? '…' : '');
            const leadClass = d.has_lead ? ' has-lead' : '';
            html += '<div class="dialog-card' + leadClass + '" data-dialog-id="' + escapeHtml(d.id) + '">';
            html += '<div class="dialog-meta">';
            html += '<span class="date">' + formatDate(d.updated_at) + '</span>';
            html += '<span class="msg-count">' + (d.message_count || 0) + ' сообщ.</span>';
            if (d.has_lead) html += '<span class="lead-badge">✓ Лид</span>';
            var uid = (d.user_id || '').toString();
            var uidShort = uid.length > 20 ? uid.slice(0, 18) + '…' : uid;
            html += '<span class="user-id" title="' + escapeHtml(uid) + '">Посетитель: ' + escapeHtml(uidShort || '—') + '</span>';
            html += '</div>';
            html += '</div>';
          }
          html += '</div>';
        }
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('.dialog-card').forEach(function(el) {
          el.addEventListener('click', function() {
            const id = el.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + id);
            route();
          });
        });
        var filterBtn = document.getElementById('dialogsFilterBtn');
        if (filterBtn) filterBtn.addEventListener('click', function() {
          var from = document.getElementById('dialogsDateFrom').value;
          var to = document.getElementById('dialogsDateTo').value;
          loadDialogs(from || undefined, to || undefined);
        });
        var resetBtn = document.getElementById('dialogsFilterReset');
        if (resetBtn) resetBtn.addEventListener('click', function() {
          document.getElementById('dialogsDateFrom').value = '';
          document.getElementById('dialogsDateTo').value = '';
          loadDialogs();
        });
      }

      async function loadDialogDetail(dialogId) {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/tenant/dialogs/' + dialogId, { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Диалог не найден.</p><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p>';
          return;
        }
        const d = await r.json();
        let html = '<h2>Диалог</h2><p><a href="#" data-goto="dialogs">← Мои диалоги</a></p><ul class="list">';
        for (const m of (d.messages || [])) {
          var content = m.content || '';
          var displayContent = (m.role === 'assistant') ? content : (content.length > 500 ? content.slice(0, 500) + '…' : content);
          html += '<li class="chat-msg ' + escapeHtml((m.role || '')) + '"><strong>' + escapeHtml(m.role === 'assistant' ? 'Бот' : (m.role || 'user')) + ':</strong> ' + escapeHtml(displayContent) + '</li>';
        }
        html += '</ul>';
        document.getElementById('content').innerHTML = html;
      }

      const CHUNK_MAX = 2000;

      async function loadChunks() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/prompt/chunks', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки чанков.</p>';
          return;
        }
        const chunks = await r.json();
        let html = '<h2>Промпт чат-бота (чанки)</h2>';
        html += '<p class="hint">Промпт собирается из чанков (каждый до 2000 символов). Порядок по position. Можно добавлять, редактировать и удалять чанки здесь или через <a href="#" data-goto="admin-chat">Админ-чат</a>.</p>';
        for (const c of chunks) {
          const contentEsc = (c.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          const questionEsc = (c.question || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          html += '<div class="chunk-card" data-chunk-id="' + c.id + '">';
          html += '<div class="chunk-meta">№' + c.position + ' · id: ' + c.id + ' · ' + (c.content || '').length + ' / ' + CHUNK_MAX + ' симв.</div>';
          html += '<div class="chunk-question-label">Вопрос (который задавал админ-помощник):</div>';
          html += '<input type="text" class="chunk-question-input" data-chunk-id="' + c.id + '" placeholder="Вопрос, на который пользователь ответил этим чанком" maxlength="1000" value="' + questionEsc + '">';
          html += '<textarea class="chunk-content" maxlength="' + CHUNK_MAX + '" data-chunk-id="' + c.id + '" placeholder="Ответ (текст чанка)">' + contentEsc + '</textarea>';
          html += '<div class="chunk-actions"><button type="button" class="saveChunk" data-chunk-id="' + c.id + '">Сохранить</button><button type="button" class="delete deleteChunk" data-chunk-id="' + c.id + '">Удалить</button></div>';
          html += '</div>';
        }
        html += '<div class="add-chunk-box"><p>Добавить чанк (ответ до ' + CHUNK_MAX + ' символов, вопрос до 1000):</p><input type="text" id="newChunkQuestion" placeholder="Вопрос (необязательно)" maxlength="1000"><textarea id="newChunkContent" placeholder="Текст чанка (ответ)..." maxlength="' + CHUNK_MAX + '"></textarea><div class="counter"><span id="newChunkCounter">0</span> / ' + CHUNK_MAX + '</div><button type="button" id="addChunkBtn">Добавить чанк</button></div>';
        document.getElementById('content').innerHTML = html;

        document.getElementById('newChunkContent').addEventListener('input', function () {
          document.getElementById('newChunkCounter').textContent = this.value.length;
        });

        document.getElementById('addChunkBtn').addEventListener('click', async () => {
          const text = document.getElementById('newChunkContent').value.trim();
          const question = document.getElementById('newChunkQuestion').value.trim() || undefined;
          if (!text) { alert('Введите текст чанка (ответ)'); return; }
          const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ content: text, question: question || null })
          });
          if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
          document.getElementById('newChunkContent').value = '';
          document.getElementById('newChunkQuestion').value = '';
          document.getElementById('newChunkCounter').textContent = '0';
          loadChunks();
        });

        document.getElementById('content').querySelectorAll('.saveChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cid = btn.getAttribute('data-chunk-id');
            const ta = document.querySelector('.chunk-content[data-chunk-id="' + cid + '"]');
            const qi = document.querySelector('.chunk-question-input[data-chunk-id="' + cid + '"]');
            const content = ta ? ta.value.trim() : '';
            const question = qi ? qi.value.trim() : '';
            if (!content) { alert('Текст чанка не может быть пустым'); return; }
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'PATCH',
              headers: headers(true),
              body: JSON.stringify({ content: content, question: question })
            });
            if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
            loadChunks();
          });
        });

        document.getElementById('content').querySelectorAll('.deleteChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Удалить этот чанк?')) return;
            const cid = btn.getAttribute('data-chunk-id');
            const res = await fetch(base + '/' + tenantId + '/me/prompt/chunks/' + cid, {
              method: 'DELETE',
              headers: headers()
            });
            if (!res.ok) { alert('Ошибка'); return; }
            loadChunks();
          });
        });
      }

      async function loadAdminPrompt() {
        if (!requireAuth()) return;
        await ensureTenant();
        const [rPrompt, rChunks] = await Promise.all([
          fetch(base + '/' + tenantId + '/me/admin-prompt', { headers: headers() }),
          fetch(base + '/' + tenantId + '/me/admin-prompt/chunks', { headers: headers() })
        ]);
        if (!rPrompt.ok || !rChunks.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки. Войдите в кабинет.</p>';
          return;
        }
        const promptData = await rPrompt.json();
        const chunks = await rChunks.json();
        const systemEsc = (promptData.system_prompt || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        let html = '<h2>Промпт админ-бота</h2>';
        html += '<p class="hint">Системный промпт и чанки (вопрос пользователю + детальное описание). Если пусто — используется промпт из файла. Админ-бот задаёт вопросы по очереди и генерирует чанки промпта клиентского бота.</p>';
        html += '<div class="admin-prompt-system">';
        html += '<label>Системный промпт</label>';
        html += '<textarea id="adminSystemPrompt" placeholder="Базовые инструкции для админ-помощника...">' + systemEsc + '</textarea>';
        html += '<button type="button" id="saveAdminSystemPrompt" style="margin-top:0.5rem;">Сохранить системный промпт</button>';
        html += '</div>';
        html += '<h3>Чанки (вопрос + описание)</h3>';
        html += '<p class="hint">Каждый чанк: вопрос, который бот задаёт пользователю, и детальное описание того, что скрывается под этим вопросом (для контекста модели).</p>';
        for (const c of chunks) {
          const qEsc = (c.question || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          const contentEsc = (c.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
          html += '<div class="admin-chunk-card chunk-card" data-admin-chunk-id="' + c.id + '">';
          html += '<div class="chunk-meta">№' + c.position + ' · id: ' + c.id + '</div>';
          html += '<div class="chunk-question-label">Вопрос пользователю:</div>';
          html += '<input type="text" class="chunk-question-input admin-chunk-question" data-admin-chunk-id="' + c.id + '" placeholder="Вопрос, который задаёт админ-бот" maxlength="1000" value="' + qEsc + '">';
          html += '<div class="chunk-question-label">Описание (что скрывается под этим вопросом):</div>';
          html += '<textarea class="admin-chunk-content" data-admin-chunk-id="' + c.id + '" placeholder="Детальное описание для контекста модели">' + contentEsc + '</textarea>';
          html += '<div class="chunk-actions"><button type="button" class="saveAdminChunk" data-admin-chunk-id="' + c.id + '">Сохранить</button><button type="button" class="delete deleteAdminChunk" data-admin-chunk-id="' + c.id + '">Удалить</button></div>';
          html += '</div>';
        }
        html += '<div class="add-chunk-box"><p>Добавить чанк:</p>';
        html += '<input type="text" id="newAdminChunkQuestion" placeholder="Вопрос пользователю" maxlength="1000" style="width:100%;margin-bottom:0.5rem;">';
        html += '<textarea id="newAdminChunkContent" placeholder="Детальное описание (что скрывается под этим вопросом)" style="width:100%;min-height:120px;"></textarea>';
        html += '<button type="button" id="addAdminChunkBtn" style="margin-top:0.5rem;">Добавить чанк</button></div>';
        document.getElementById('content').innerHTML = html;

        document.getElementById('saveAdminSystemPrompt').addEventListener('click', async () => {
          const text = document.getElementById('adminSystemPrompt').value;
          const res = await fetch(base + '/' + tenantId + '/me/admin-prompt', {
            method: 'PATCH',
            headers: headers(true),
            body: JSON.stringify({ system_prompt: text })
          });
          if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
          alert('Системный промпт сохранён.');
        });

        document.getElementById('content').querySelectorAll('.saveAdminChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            const cid = btn.getAttribute('data-admin-chunk-id');
            const qi = document.querySelector('.admin-chunk-question[data-admin-chunk-id="' + cid + '"]');
            const ta = document.querySelector('.admin-chunk-content[data-admin-chunk-id="' + cid + '"]');
            const question = qi ? qi.value.trim() : '';
            const content = ta ? ta.value.trim() : '';
            if (!content) { alert('Описание не может быть пустым'); return; }
            const res = await fetch(base + '/' + tenantId + '/me/admin-prompt/chunks/' + cid, {
              method: 'PATCH',
              headers: headers(true),
              body: JSON.stringify({ content: content, question: question || null })
            });
            if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
            loadAdminPrompt();
          });
        });

        document.getElementById('content').querySelectorAll('.deleteAdminChunk').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Удалить этот чанк?')) return;
            const cid = btn.getAttribute('data-admin-chunk-id');
            const res = await fetch(base + '/' + tenantId + '/me/admin-prompt/chunks/' + cid, {
              method: 'DELETE',
              headers: headers()
            });
            if (!res.ok) { alert('Ошибка'); return; }
            loadAdminPrompt();
          });
        });

        document.getElementById('addAdminChunkBtn').addEventListener('click', async () => {
          const question = document.getElementById('newAdminChunkQuestion').value.trim() || undefined;
          const content = document.getElementById('newAdminChunkContent').value.trim();
          if (!content) { alert('Введите описание чанка'); return; }
          const res = await fetch(base + '/' + tenantId + '/me/admin-prompt/chunks', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ content: content, question: question || null })
          });
          if (!res.ok) { const j = await res.json().catch(() => ({})); alert(j.detail || 'Ошибка'); return; }
          document.getElementById('newAdminChunkQuestion').value = '';
          document.getElementById('newAdminChunkContent').value = '';
          loadAdminPrompt();
        });
      }

      let adminChatInited = false;
      const adminChatHistory = [];

      function initAdminChatOnce() {
        if (adminChatInited) return;
        const log = document.getElementById('adminChatLog');
        const input = document.getElementById('adminChatInput');
        const send = document.getElementById('adminChatSend');
        if (!log || !send) return;
        function appendAdminMsg(role, text) {
          const div = document.createElement('div');
          div.className = 'chat-msg ' + role;
          div.textContent = (role === 'user' ? 'Вы: ' : 'АДМИН ПОМОЩНИК: ') + text;
          log.appendChild(div);
          log.scrollTop = log.scrollHeight;
        }
        (async function sendInitialAndShowReply() {
          const initMsg = 'Начало сеанса. Посмотри текущее состояние чанков выше. Сразу задай первый или следующий вопрос по сценарию (роль и задача → стиль → контекст и ограничения → формат ответа → формулировки чанков). Не приветствуй и не представляйся — только один вопрос или предложение по контексту.';
          if (!tenantId) await ensureTenant();
          adminChatHistory.push({ role: 'user', content: initMsg });
          try {
            const res = await fetch(base + '/' + tenantId + '/admin/chat', {
              method: 'POST',
              headers: headers(true),
              body: JSON.stringify({ message: initMsg, history: [] })
            });
            const data = res.ok ? await res.json() : null;
            const reply = (data && data.reply) ? data.reply : (res.ok ? '' : 'Ошибка загрузки. Попробуйте написать сообщение.');
            if (reply) {
              appendAdminMsg('assistant', reply);
              adminChatHistory.push({ role: 'assistant', content: reply });
            }
          } catch (e) {
            appendAdminMsg('assistant', 'Ошибка: ' + (e.message || 'сеть'));
            adminChatHistory.push({ role: 'assistant', content: 'Ошибка: ' + (e.message || 'сеть') });
          }
        })();
        send.addEventListener('click', async () => {
          const msg = (input.value || '').trim();
          if (!msg) return;
          if (!tenantId) await ensureTenant();
          input.value = '';
          appendAdminMsg('user', msg);
          adminChatHistory.push({ role: 'user', content: msg });
          const res = await fetch(base + '/' + tenantId + '/admin/chat', {
            method: 'POST',
            headers: headers(true),
            body: JSON.stringify({ message: msg, history: adminChatHistory.slice(0, -1) })
          });
          if (!res.ok) {
            const errText = await res.text();
            appendAdminMsg('assistant', 'Ошибка: ' + errText);
            adminChatHistory.push({ role: 'assistant', content: 'Ошибка: ' + errText });
            return;
          }
          const data = await res.json();
          const reply = data.reply || '';
          appendAdminMsg('assistant', reply);
          adminChatHistory.push({ role: 'assistant', content: reply });
        });
        adminChatInited = true;
      }

      document.getElementById('adminChatToggler').addEventListener('click', function() {
        document.body.classList.toggle('show-admin-chat');
        if (document.body.classList.contains('show-admin-chat')) {
          if (requireAuth()) {
            ensureTenant().then(function() { initAdminChatOnce(); });
          } else {
            initAdminChatOnce();
          }
        }
      });
      document.getElementById('adminChatClose').addEventListener('click', function() {
        document.body.classList.remove('show-admin-chat');
      });

      function escapeHtml(s) {
        if (s == null) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      async function loadLeads(dateFromVal, dateToVal) {
        if (!requireAuth()) return;
        await ensureTenant();
        let url = base + '/' + tenantId + '/me/leads?limit=50&offset=0';
        if (dateFromVal) url += '&date_from=' + encodeURIComponent(dateFromVal);
        if (dateToVal) url += '&date_to=' + encodeURIComponent(dateToVal);
        const r = await fetch(url, { headers: headers() });
        if (!r.ok) {
          const errBody = await r.text();
          let errMsg = 'Ошибка загрузки лидов.';
          try { const j = JSON.parse(errBody); errMsg = j.detail || errMsg; } catch (_) {}
          if (r.status === 401) errMsg = 'Войдите в кабинет.';
          document.getElementById('content').innerHTML = '<p class="error">' + escapeHtml(errMsg) + '</p>';
          return;
        }
        let data;
        try { data = await r.json(); } catch (_) {
          document.getElementById('content').innerHTML = '<p class="error">Неверный ответ сервера.</p>';
          return;
        }
        const leads = Array.isArray(data) ? data : (data.items || []);
        let html = '<h2>Лиды</h2>';
        html += '<p class="hint">Контакты (email, телефон), оставленные посетителями в чате. Один лид на диалог.</p>';
        html += '<div class="date-filter">';
        html += '<label>С: <input type="date" id="leadsDateFrom" value="' + escapeHtml(dateFromVal || '') + '"></label>';
        html += '<label>По: <input type="date" id="leadsDateTo" value="' + escapeHtml(dateToVal || '') + '"></label>';
        html += '<button type="button" id="leadsFilterBtn">Применить</button>';
        html += '<button type="button" class="reset-btn" id="leadsFilterReset">Сбросить</button>';
        html += '</div>';
        if (leads.length === 0) {
          html += '<p>Нет лидов за выбранный период.</p>';
        } else {
          html += '<ul class="list leads-list">';
          for (const l of leads) {
            html += '<li class="lead-item">';
            html += '<span class="contact">' + escapeHtml(l.contact_text) + '</span>';
            html += '<div class="meta">user: ' + escapeHtml(l.user_id) + ' · диалог: <a href="#" class="lead-dialog-link" data-dialog-id="' + escapeHtml(l.dialog_id) + '">открыть</a></div>';
            html += '<div class="lead-date">' + formatDate(l.updated_at || l.created_at) + '</div>';
            html += '</li>';
          }
          html += '</ul>';
        }
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').querySelectorAll('a.lead-dialog-link').forEach(function(a) {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            const dialogId = a.getAttribute('data-dialog-id');
            window.history.pushState({}, '', '/' + tenantSlug + '/my/dialogs/' + dialogId);
            route();
          });
        });
        var filterBtn = document.getElementById('leadsFilterBtn');
        if (filterBtn) filterBtn.addEventListener('click', function() {
          loadLeads(document.getElementById('leadsDateFrom').value || undefined, document.getElementById('leadsDateTo').value || undefined);
        });
        var resetBtn = document.getElementById('leadsFilterReset');
        if (resetBtn) resetBtn.addEventListener('click', function() {
          document.getElementById('leadsDateFrom').value = '';
          document.getElementById('leadsDateTo').value = '';
          loadLeads();
        });
      }

      async function loadGallery() {
        if (!requireAuth()) return;
        await ensureTenant();
        document.getElementById('content').innerHTML = '<div class="page-gallery"><h2>Галерея</h2><p class="hint">Группы изображений для показа в чате (команды LIST_GALLERIES, SHOW_GALLERY).</p><p class="content-loading">Загрузка…</p></div>';
        const r = await fetch(base + '/' + tenantId + '/me/gallery/groups', { headers: headers() });
        let html = '<div class="page-gallery"><h2>Галерея</h2><p class="hint">Группы изображений для показа в чате (команды LIST_GALLERIES, SHOW_GALLERY).</p>';
        if (!r.ok) {
          document.getElementById('content').innerHTML = html + '<p class="error">Ошибка загрузки. Убедитесь, что микросервис галереи запущен.</p></div>';
          return;
        }
        const groups = await r.json();
        html += '<div class="panel gallery-create-panel"><h3>Создать группу</h3><input type="text" id="galleryGroupName" placeholder="Название группы" maxlength="256"><textarea id="galleryGroupDesc" placeholder="Описание (необязательно)" rows="2"></textarea><button type="button" id="galleryCreateGroupBtn">Создать группу</button></div>';
        if (groups.length === 0) {
          html += '<p class="hint">Нет групп. Создайте группу и добавьте в неё изображения (загрузка с компьютера).</p>';
        } else {
          html += '<div class="gallery-cards">';
          for (const g of groups) {
            html += '<div class="gallery-card" data-group-id="' + g.id + '">';
            html += '<div class="gallery-card-title">' + escapeHtml(g.name) + '</div>';
            html += '<div class="gallery-card-meta">' + (g.image_count || 0) + ' фото</div>';
            if (g.description) html += '<p class="gallery-card-desc">' + escapeHtml((g.description || '').slice(0, 120)) + (g.description.length > 120 ? '…' : '') + '</p>';
            html += '<div class="gallery-card-actions"><button type="button" class="gallery-view-group" data-group-id="' + g.id + '">Открыть</button><button type="button" class="delete gallery-delete-group" data-group-id="' + g.id + '">Удалить</button></div></div>';
          }
          html += '</div>';
        }
        document.getElementById('content').innerHTML = html + '</div>';
        document.getElementById('galleryCreateGroupBtn')?.addEventListener('click', async function() {
          const name = document.getElementById('galleryGroupName').value.trim();
          if (!name) { alert('Введите название'); return; }
          const res = await fetch(base + '/' + tenantId + '/me/gallery/groups', { method: 'POST', headers: headers(true), body: JSON.stringify({ tenant_id: tenantId, name: name, description: document.getElementById('galleryGroupDesc').value.trim() || null }) });
          if (!res.ok) { alert('Ошибка: ' + await res.text()); return; }
          loadGallery();
        });
        document.getElementById('content').querySelectorAll('.gallery-view-group').forEach(function(btn) {
          btn.addEventListener('click', function() { window.history.pushState({}, '', '/' + tenantSlug + '/my/gallery/' + btn.getAttribute('data-group-id')); route(); });
        });
        document.getElementById('content').querySelectorAll('.gallery-delete-group').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            if (!confirm('Удалить группу?')) return;
            const id = btn.getAttribute('data-group-id');
            const res = await fetch(base + '/' + tenantId + '/me/gallery/groups/' + id, { method: 'DELETE', headers: headers() });
            if (res.ok) loadGallery(); else alert('Ошибка удаления');
          });
        });
      }

      async function loadGalleryGroup(groupId) {
        if (!requireAuth()) return;
        await ensureTenant();
        document.getElementById('content').innerHTML = '<div class="content-loading">Загрузка группы…</div>';
        const r = await fetch(base + '/' + tenantId + '/me/gallery/groups/' + groupId, { headers: headers() });
        if (!r.ok) { document.getElementById('content').innerHTML = '<p class="error">Группа не найдена</p>'; return; }
        const g = await r.json();
        let html = '<div class="page-gallery"><div class="gallery-detail-back"><a href="#" data-goto="gallery">← К списку галерей</a></div>';
        html += '<h2>' + escapeHtml(g.name) + '</h2>';
        if (g.description) html += '<p class="hint">' + escapeHtml(g.description) + '</p>';
        html += '<div class="panel gallery-create-panel"><h3>Добавить изображение</h3><input type="file" id="galleryImageFile" accept="image/jpeg,image/png,image/gif,image/webp" style="display:none"><button type="button" id="galleryAddImageBtn">Выбрать файл…</button><span id="galleryUploadStatus" class="hint"></span><div id="galleryProgressWrap" class="upload-progress-wrap"><div class="upload-progress-bar"><div class="fill" id="galleryProgressBar"></div></div><div class="upload-progress-text" id="galleryProgressText"></div></div></div>';
        html += '<h3>Изображения</h3>';
        if (!g.images || g.images.length === 0) {
          html += '<p class="hint">В группе пока нет изображений. Нажмите «Выбрать файл…» и загрузите изображение с компьютера.</p>';
        } else {
          html += '<div class="gallery-images-grid">';
          for (const img of g.images) {
            html += '<div class="gallery-image-item"><img src="' + escapeHtml(img.url) + '" alt="" onerror="this.style.background=\'var(--bg)\';this.style.minHeight=\'120px\'"><span class="img-url" title="' + escapeHtml(img.url) + '">' + escapeHtml(img.url.length > 40 ? img.url.slice(0, 40) + '…' : img.url) + '</span><button type="button" class="delete gallery-delete-image img-remove" data-image-id="' + img.id + '">Удалить</button></div>';
          }
          html += '</div>';
        }
        document.getElementById('content').innerHTML = html + '</div>';
        document.querySelector('[data-goto="gallery"]')?.addEventListener('click', function(e) { e.preventDefault(); window.history.pushState({}, '', '/' + tenantSlug + '/my/gallery'); route(); });
        document.getElementById('galleryAddImageBtn')?.addEventListener('click', function() { document.getElementById('galleryImageFile').click(); });
        document.getElementById('galleryImageFile')?.addEventListener('change', function() {
          const input = this;
          const file = input.files && input.files[0];
          if (!file) return;
          const statusEl = document.getElementById('galleryUploadStatus');
          const wrap = document.getElementById('galleryProgressWrap');
          const barEl = document.getElementById('galleryProgressBar');
          const textEl = document.getElementById('galleryProgressText');
          statusEl.textContent = '';
          wrap.classList.add('active');
          barEl.style.width = '0%';
          textEl.textContent = 'Загрузка 0%';
          const fd = new FormData();
          fd.append('file', file);
          const xhr = new XMLHttpRequest();
          xhr.open('POST', base + '/' + tenantId + '/me/gallery/groups/' + groupId + '/images');
          xhr.setRequestHeader('Authorization', 'Bearer ' + (localStorage.getItem('cip_access_token') || ''));
          xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) { var pct = Math.round((e.loaded / e.total) * 100); barEl.style.width = pct + '%'; textEl.textContent = 'Загрузка ' + pct + '%'; }
          });
          xhr.addEventListener('load', function() {
            wrap.classList.remove('active');
            if (xhr.status >= 200 && xhr.status < 300) { statusEl.textContent = 'Добавлено.'; barEl.style.width = '100%'; input.value = ''; loadGalleryGroup(groupId); }
            else { try { var err = JSON.parse(xhr.responseText); statusEl.textContent = ''; alert('Ошибка: ' + (err.detail || xhr.statusText)); } catch (e) { alert('Ошибка: ' + xhr.statusText); } input.value = ''; }
          });
          xhr.addEventListener('error', function() { wrap.classList.remove('active'); statusEl.textContent = ''; alert('Ошибка сети'); input.value = ''; });
          xhr.send(fd);
        });
        document.getElementById('content').querySelectorAll('.gallery-delete-image').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            if (!confirm('Удалить изображение?')) return;
            const imgId = btn.getAttribute('data-image-id');
            const res = await fetch(base + '/' + tenantId + '/me/gallery/groups/' + groupId + '/images/' + imgId, { method: 'DELETE', headers: headers() });
            if (res.ok) loadGalleryGroup(groupId); else alert('Ошибка удаления');
          });
        });
      }

      async function loadRag() {
        if (!requireAuth()) return;
        await ensureTenant();
        document.getElementById('content').innerHTML = '<div class="page-rag"><h2>Документы (RAG)</h2><p class="hint">PDF загружаются и распознаются в markdown. В чате доступны команды RAG_LIST_DOCUMENTS, RAG_GET_DOCUMENT, RAG_SEARCH.</p><p class="content-loading">Загрузка…</p></div>';
        const r = await fetch(base + '/' + tenantId + '/me/rag/documents', { headers: headers() });
        let html = '<div class="page-rag"><h2>Документы (RAG)</h2><p class="hint">PDF загружаются и распознаются в markdown. В чате бот может искать по документам и выдавать выдержки.</p>';
        if (!r.ok) {
          document.getElementById('content').innerHTML = html + '<p class="error">Ошибка загрузки. Убедитесь, что микросервис RAG запущен.</p></div>';
          return;
        }
        const docs = await r.json();
        html += '<div class="panel rag-upload-panel"><h3>Загрузить PDF</h3><input type="file" id="ragDocFile" accept=".pdf"><button type="button" id="ragUploadBtn">Преобразовать и предпросмотр</button><div id="ragProgressWrap" class="upload-progress-wrap"><div class="upload-progress-bar"><div class="fill" id="ragProgressBar"></div></div><div class="upload-progress-text" id="ragProgressText"></div></div></div>';
        if (docs.length === 0) {
          html += '<p class="hint">Нет документов. Загрузите PDF — он будет распознан и сохранён в виде текста (markdown).</p>';
        } else {
          html += '<h3>Список документов</h3><ul class="rag-doc-list">';
          for (const d of docs) {
            var meta = formatDate(d.created_at);
            if (d.source_file_name) meta += ' · ' + escapeHtml(d.source_file_name);
            html += '<li class="rag-doc-item"><div class="rag-doc-info"><div class="rag-doc-name">' + escapeHtml(d.name) + '</div><div class="rag-doc-meta">' + meta + '</div></div><div class="rag-doc-actions"><button type="button" class="rag-view-doc" data-doc-id="' + d.id + '">Просмотр</button><button type="button" class="delete rag-delete-doc" data-doc-id="' + d.id + '">Удалить</button></div></li>';
          }
          html += '</ul>';
        }
        document.getElementById('content').innerHTML = html + '</div>';
        document.getElementById('ragUploadBtn')?.addEventListener('click', function() {
          const fileInput = document.getElementById('ragDocFile');
          if (!fileInput?.files?.length) { alert('Выберите PDF'); return; }
          const wrap = document.getElementById('ragProgressWrap');
          const barEl = document.getElementById('ragProgressBar');
          const textEl = document.getElementById('ragProgressText');
          wrap.classList.add('active');
          barEl.style.width = '0%';
          textEl.innerHTML = 'Загрузка файла 0%';
          const fd = new FormData();
          fd.append('file', fileInput.files[0]);
          const sourceFileName = fileInput.files[0].name || null;
          const xhr = new XMLHttpRequest();
          xhr.open('POST', base + '/' + tenantId + '/me/rag/documents/preview');
          xhr.setRequestHeader('Authorization', headers().Authorization || '');
          xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) { var pct = Math.round((e.loaded / e.total) * 100); barEl.style.width = pct + '%'; textEl.innerHTML = 'Загрузка файла ' + pct + '%'; }
          });
          xhr.upload.addEventListener('load', function() {
            barEl.style.width = '100%'; textEl.innerHTML = '<span class="upload-progress-spinner"></span>Преобразование в Markdown…';
          });
          xhr.addEventListener('load', function() {
            wrap.classList.remove('active');
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                var data = JSON.parse(xhr.responseText);
                var modal = document.createElement('div');
                modal.className = 'rag-preview-overlay';
                modal.innerHTML = '<div class="rag-preview-modal"><h3>Предпросмотр Markdown</h3><div class="rag-preview-body"><label>Название документа</label><input type="text" id="ragPreviewName" value="' + escapeHtml(data.suggested_name || 'document') + '"><label>Текст (Markdown)</label><textarea id="ragPreviewMd" spellcheck="false">' + escapeHtml(data.markdown || '') + '</textarea></div><div class="rag-preview-footer"><button type="button" class="btn-cancel rag-preview-cancel">Отмена</button><button type="button" class="btn-save rag-preview-save">Сохранить в базу</button></div></div>';
                document.body.appendChild(modal);
                modal.querySelector('.rag-preview-cancel').onclick = function() { modal.remove(); };
                modal.querySelector('.rag-preview-save').onclick = async function() {
                  var name = document.getElementById('ragPreviewName').value.trim() || 'document';
                  var contentMd = document.getElementById('ragPreviewMd').value;
                  if (!contentMd) { alert('Текст не может быть пустым'); return; }
                  var saveRes = await fetch(base + '/' + tenantId + '/me/rag/documents/save', { method: 'POST', headers: Object.assign({ 'Content-Type': 'application/json' }, headers()), body: JSON.stringify({ name: name, content_md: contentMd, source_file_name: sourceFileName || null }) });
                  if (saveRes.ok) { modal.remove(); loadRag(); }
                  else { alert('Ошибка сохранения: ' + await saveRes.text()); }
                };
                modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
              } catch (e) { alert('Ошибка: ' + (e.message || String(e))); }
            } else { alert('Ошибка: ' + (xhr.responseText || xhr.statusText)); }
          });
          xhr.addEventListener('error', function() { wrap.classList.remove('active'); alert('Ошибка сети'); });
          xhr.send(fd);
        });
        document.getElementById('content').querySelectorAll('.rag-view-doc').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            const id = btn.getAttribute('data-doc-id');
            try {
              const res = await fetch(base + '/' + tenantId + '/me/rag/documents/' + id, { headers: headers() });
              if (!res.ok) { alert('Ошибка загрузки документа'); return; }
              const data = await res.json();
              var modal = document.createElement('div');
              modal.className = 'rag-preview-overlay';
              modal.innerHTML = '<div class="rag-preview-modal"><h3>Содержимое: ' + escapeHtml(data.name || 'документ') + '</h3><div class="rag-preview-body"><label>Текст (Markdown)</label><textarea id="ragViewMd" spellcheck="false" readonly>' + escapeHtml(data.content_md || '') + '</textarea></div><div class="rag-preview-footer"><button type="button" class="btn-cancel rag-view-close">Закрыть</button></div></div>';
              document.body.appendChild(modal);
              modal.querySelector('.rag-view-close').onclick = function() { modal.remove(); };
              modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
            } catch (e) { alert('Ошибка: ' + (e.message || String(e))); }
          });
        });
        document.getElementById('content').querySelectorAll('.rag-delete-doc').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            if (!confirm('Удалить документ?')) return;
            const id = btn.getAttribute('data-doc-id');
            const res = await fetch(base + '/' + tenantId + '/me/rag/documents/' + id, { method: 'DELETE', headers: headers() });
            if (res.ok) loadRag(); else alert('Ошибка удаления');
          });
        });
      }

      async function loadProfile() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/profile', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки профиля</p>';
          return;
        }
        const p = await r.json();
        const sysEsc = (p.system_prompt || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        let html = '<h2>Профиль</h2>';
        html += '<p class="hint">Здесь вы можете задать базовый системный промпт клиентского бота (основные инструкции). Дополнительные детали можно добавлять чанками в разделе «Промпт».</p>';
        html += '<form id="profileForm" class="panel">';
        html += '<p><strong>user_id:</strong> ' + (p.user_id || '') + '</p>';
        html += '<label>Имя (отображается в кабинете)<br><input type="text" id="profileDisplayName" value="' + (p.display_name || '') + '" maxlength="256"></label>';
        html += '<label>Контакт (email/телефон/мессенджер)<br><input type="text" id="profileContact" value="' + (p.contact || '') + '" maxlength="256"></label>';
        html += '<label>Системный промпт клиентского бота<br><textarea id="profileSystemPrompt" rows="12" spellcheck="false" placeholder="Опишите здесь роль агента, бизнес-цель и ключевые правила. Можно вписать ответы по анкете: роль и цель, сценарий диалога, продукты и триггеры, как запрашивать контакты, как реагировать на нештатные ситуации.">' + sysEsc + '</textarea></label>';
        html += '<div style="margin-top:1rem;"><button type="submit">Сохранить профиль</button></div>';
        html += '</form>';
        document.getElementById('content').innerHTML = html;
        const form = document.getElementById('profileForm');
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          const body = {
            display_name: document.getElementById('profileDisplayName').value.trim() || null,
            contact: document.getElementById('profileContact').value.trim() || null,
            system_prompt: document.getElementById('profileSystemPrompt').value
          };
          const res = await fetch(base + '/' + tenantId + '/me/profile', {
            method: 'PATCH',
            headers: Object.assign({ 'Content-Type': 'application/json' }, headers(true)),
            body: JSON.stringify(body)
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            alert(data.detail || 'Ошибка сохранения профиля');
            return;
          }
          alert('Профиль сохранён.');
          loadProfile();
        });
      }

      async function loadMy() {
        if (!requireAuth()) return;
        await ensureTenant();
        const r = await fetch(base + '/' + tenantId + '/me/embed', { headers: headers() });
        if (!r.ok) {
          document.getElementById('content').innerHTML = '<p class="error">Ошибка загрузки.</p>';
          return;
        }
        const data = await r.json();
        const code = (data.iframe_code || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        document.getElementById('content').innerHTML =
          '<h2>Главная</h2>' +
          '<p class="hint">Тестируйте бота в чате и скопируйте код для вставки на сайт. Диалоги пользователей — в <a href="#" data-goto="dialogs">Мои диалоги</a>.</p>' +
          '<div class="main-page-wrap">' +
          '<div class="main-page-chat">' +
          '<p class="hint" style="margin-bottom:0.5rem;">Чат для теста (режим теста — в БД не сохраняется)</p>' +
          '<iframe id="chatEmbedFrame" class="chat-frame" src="/' + tenantSlug + '/chat/embed" title="Чат для теста"></iframe>' +
          '</div>' +
          '<div class="main-page-embed">' +
          '<p class="hint" style="margin-bottom:0.5rem;">Вставка на ваш сайт</p>' +
          '<p class="hint">Тенант: <strong>' + escapeHtml(tenantSlug) + '</strong>. Задайте в .env <code>FRONTEND_BASE_URL</code>.</p>' +
          '<pre class="embed-code" id="embedCodePre">' + code + '</pre>' +
          '<div class="embed-actions"><button type="button" id="copyEmbedBtn">Копировать код</button></div>' +
          '</div>' +
          '</div>';
        var frame = document.getElementById('chatEmbedFrame');
        if (frame) {
          frame.addEventListener('load', function() {
            try {
              var uid = localStorage.getItem('cip_user_id');
              var token = localStorage.getItem('cip_access_token');
              if (uid && token) {
                frame.contentWindow.postMessage({ type: 'cip_auth', user_id: uid, token: token, is_test: true }, window.location.origin);
              }
            } catch (_) {}
          });
        }
        var copyBtn = document.getElementById('copyEmbedBtn');
        if (copyBtn) {
          copyBtn.addEventListener('click', function() {
            var pre = document.getElementById('embedCodePre');
            var text = pre ? pre.textContent : '';
            navigator.clipboard.writeText(text).then(function() { alert('Код скопирован в буфер обмена.'); }).catch(function() { alert('Не удалось скопировать.'); });
          });
        }
      }

      function route() {
        const segs = window.location.pathname.split('/').filter(Boolean);
        const page = segs[2] || 'my';
        setLinks();
        renderAuthLinks();
        if (page === 'my' || page === 'embed') loadMy();
        else if (page === 'dialogs' && segs[3]) loadDialogDetail(segs[3]);
        else if (page === 'dialogs') loadDialogs();
        else if (page === 'prompt') loadChunks();
        else if (page === 'admin-prompt') loadAdminPrompt();
        else if (page === 'gallery' && segs[3]) loadGalleryGroup(segs[3]);
        else if (page === 'gallery') loadGallery();
        else if (page === 'rag') loadRag();
        else if (page === 'leads') loadLeads();
        else if (page === 'profile') loadProfile();
        else loadMy();
      }

      document.querySelectorAll('nav a[data-page]').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const page = a.getAttribute('data-page');
          window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
          route();
        });
      });
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-goto]');
        if (!a) return;
        e.preventDefault();
        const page = a.getAttribute('data-goto');
        window.history.pushState({}, '', '/' + tenantSlug + (page === 'my' ? '/my' : '/my/' + page));
        route();
      });
      window.onpopstate = route;
      route();
    })();
  </script>
</body>
</html>
