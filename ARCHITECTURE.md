# Архитектура приложения saasaisite

## Ядро (core)

- **auth** — регистрация с подтверждением по e-mail, логин, JWT.
- **chat** — чат с клиентами: системный промпт из чанков тенанта, SSE-стриминг ответа LLM.
- **cabinet** — личный кабинет (JWT): диалоги, чанки промпта (CRUD), страница «Вставка на сайт» (iframe), админ-чат, профиль, сохранённое.

Расширение функционала не должно требовать переделки этого ядра.

## Промпт бота

Системный промпт для чата с клиентами собирается из **чанков** (таблица `prompt_chunk`): у каждого тенанта список чанков до 500 символов, порядок по полю `position`. Чанки склеиваются в один текст. Если чанков нет — используется промпт из файла по умолчанию (`prompts/system_prompt.txt`).

## Вставка чата на сайт

- Маршрут `/{slug}/chat/embed` отдаёт ту же страницу чата для встройки в iframe.
- В кабинете раздел «Вставка на сайт» отдаёт готовый HTML-код iframe для копирования.

## Как расширять

Добавление галереи, MCP-сервера, RAG и т.п. делается **отдельными модулями** без переписывания ядра:

1. **Новые таблицы и модели** — отдельные миграции Alembic, модели в `app/models.py` или в подмодуле (например `app/features/gallery/models.py`).
2. **Новые API** — отдельный роутер (например `app/routers/gallery.py` или `app/features/gallery/router.py`), подключение в `app/main.py`: `app.include_router(gallery.router)`.
3. **Интеграция с чатом** — при необходимости обогащение контекста (промпт, RAG) выносится в сервисный слой; чат вызывает общий метод «получить системный промпт для тенанта», внутри которого можно подмешивать RAG, триггеры и т.д.
4. **Конфиг** — новые переменные окружения в `app/config.py` и `.env.example`.

Таким образом, ядро остаётся стабильным; новые фичи подключаются маршрутами и опциональными зависимостями.
