# Архитектура приложения saasaisite

## Мультитенантность

Система **многопользовательская**: каждый тенант (клиент) имеет свой `tenant_id` и изолированные данные.

- **Тенант** задаётся slug в URL: `/{tenant_slug}/login`, `/{tenant_slug}/my`, `/{tenant_slug}/chat/embed`. Пользователь регистрируется и входит в контексте одного тенанта.
- **Данные по тенанту:** промпты (чанки), диалоги, сообщения, лиды, сохранённое, профили — у всех сущностей есть `tenant_id`, все выборки и записи идут с фильтром по `tenant_id`.
- **Промпты** — чанки в `prompt_chunk` привязаны к тенанту; чат-бот использует только промпт своего тенанта.
- **Диалоги и сообщения** — создаются и читаются только в рамках `tenant_id` из пути запроса.
- **Лиды** — контакты из диалогов; список лидов в кабинете — только по текущему тенанту.
- **Код вставки iframe** — в URL подставляется slug текущего тенанта: `{BASE_URL}/{tenant_slug}/chat/embed`.

JWT при логине содержит `tenant_id`; все запросы кабинета проверяют совпадение `tenant_id` из пути и токена.

## Ядро (core)

- **auth** — регистрация с подтверждением по e-mail, логин, JWT.
- **chat** — чат с клиентами: системный промпт из чанков тенанта, SSE-стриминг ответа LLM.
- **cabinet** — личный кабинет (JWT): диалоги, чанки промпта (CRUD), страница «Вставка на сайт» (iframe), админ-чат, профиль, сохранённое.

Расширение функционала не должно требовать переделки этого ядра.

## Промпт бота

Системный промпт для чата с клиентами собирается из **чанков** (таблица `prompt_chunk`): у каждого тенанта список чанков до 500 символов, порядок по полю `position`. Чанки склеиваются в один текст. Если чанков нет — используется промпт из файла по умолчанию (`prompts/system_prompt.txt`).

## Вставка чата на сайт

- Маршрут `/{slug}/chat/embed` отдаёт ту же страницу чата для встройки в iframe.
- В кабинете раздел «Вставка на сайт» отдаёт готовый HTML-код iframe для копирования.

## Как расширять

Добавление галереи, MCP-сервера, RAG и т.п. делается **отдельными модулями** без переписывания ядра:

1. **Новые таблицы и модели** — отдельные миграции Alembic, модели в `app/models.py` или в подмодуле (например `app/features/gallery/models.py`).
2. **Новые API** — отдельный роутер (например `app/routers/gallery.py` или `app/features/gallery/router.py`), подключение в `app/main.py`: `app.include_router(gallery.router)`.
3. **Интеграция с чатом** — при необходимости обогащение контекста (промпт, RAG) выносится в сервисный слой; чат вызывает общий метод «получить системный промпт для тенанта», внутри которого можно подмешивать RAG, триггеры и т.д.
4. **Конфиг** — новые переменные окружения в `app/config.py` и `.env.example`.

Таким образом, ядро остаётся стабильным; новые фичи подключаются маршрутами и опциональными зависимостями.
